<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/student-management.css">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Modal CSS -->
    <style>
        :root {
            --primary-color: #4f46e5;
            --primary-light: #818cf8;
            --primary-dark: #4338ca;
            --bg-color: #f8fafc;
            --sidebar-bg: #1e293b;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --card-bg: #ffffff;
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f5f7fa;
            color: var(--gray-800);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        a {
            text-decoration: none;
            color: inherit;
        }

        ul {
            list-style: none;
        }

        /* Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: #1e3a8a; /* Dark blue color */
            color: #e5e7eb; /* Light gray text for better contrast */
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
            transform: translateX(-100%);
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-logo {
            padding: 1.5rem 1.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .logo-icon {
            background: var(--primary);
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .sidebar-logo h2 {
            color: white;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            background: none;
            -webkit-text-fill-color: white;
        }

        .sidebar-profile {
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .profile-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            color: white;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .profile-role {
            color: var(--gray-400);
            font-size: 0.8rem;
            margin-top: 0.1rem;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .sidebar-menu li {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--gray-400);
            transition: var(--transition);
            font-size: 0.95rem;
            font-weight: 500;
            border-left: 3px solid transparent;
        }

        .sidebar-menu li i {
            width: 24px;
            text-align: center;
            font-size: 1.1rem;
        }

        .sidebar-menu li:hover {
            background: rgba(255, 255, 255, 0.05);
            color: white;
            padding-left: 1.75rem;
        }

        .sidebar-menu li.active {
            background: rgba(79, 70, 229, 0.2);
            color: var(--primary-light);
            border-left-color: var(--primary);
        }

        .sidebar-menu li.active i {
            color: var(--primary-light);
        }

        .divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.05);
            margin: 0.5rem 0;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 0;
            transition: var(--transition);
            min-height: 100vh;
            background: #f5f7fa;
            padding: 1.5rem;
            padding-top: 5rem;
        }

        .sidebar.active + .main-content {
            margin-left: 280px;
        }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1100;
            box-shadow: var(--shadow);
            color: var(--gray-700);
            transition: var(--transition);
        }

        .sidebar-toggle:hover {
            background: var(--primary);
            color: white;
        }

        /* Responsive */
        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 280px;
                padding: 2rem;
                padding-top: 2rem;
            }
            
            .sidebar-toggle {
                display: none;
            }
        }

        /* Dashboard Styles */
        .dashboard-header {
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .dashboard-header h1 {
            color: var(--text-primary);
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.25rem;
            margin-bottom: 1.5rem;
        }
        
        /* Stat Cards */
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
            border: 1px solid #e2e8f0;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--primary-light));
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .stat-card h3 {
            margin: 0 0 0.75rem 0;
            font-size: 0.95rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        
        .stat-card h3 i {
            font-size: 1.1rem;
            color: var(--primary-color);
            background: rgba(79, 70, 229, 0.1);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0.5rem 0;
            line-height: 1.2;
            font-family: 'Inter', sans-serif;
        }
        
        .stat-trend {
            font-size: 0.8rem;
            color: #10b981;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
        }
        
        .stat-trend.down {
            color: #ef4444;
        }
        
        /* Attendance Stats */
        .attendance-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .attendance-stat {
            text-align: center;
            padding: 1rem;
            border-radius: 10px;
            background: rgba(99, 102, 241, 0.05);
            transition: var(--transition);
            border: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .attendance-stat:hover {
            transform: translateY(-2px);
            background: rgba(99, 102, 241, 0.1);
        }
        
        .attendance-stat .stat-value {
            font-size: 1.5rem;
            margin: 0.5rem 0;
            color: var(--primary-color);
            font-weight: 700;
        }
        
        .attendance-stat .stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
        }
        
        /* Progress Bar */
        .progress {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 0.75rem;
            overflow: hidden;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        /* Library Tabs */
        .library-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 1.5rem;
        }
        
        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #64748b;
            transition: all 0.2s ease;
        }
        
        .tab-btn:hover {
            color: #334155;
            border-bottom-color: #cbd5e1;
        }
        
        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .library-tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .library-tab-content.active {
            display: block;
        }

        /* Attendance Card Styles */
        .attendance-card {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .attendance-stats {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }
        
        .attendance-stat {
            text-align: center;
            padding: 10px;
            flex: 1;
        }
        
        .stat-label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .stat-value.present {
            color: #28a745;
        }
        
        .stat-value.absent {
            color: #dc3545;
        }
        
        .attendance-date {
            text-align: center;
            color: #6c757d;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        /* Return Button */
        /* Class Management Styles */
        .class-management-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .profile-header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            background-color: transparent;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            margin-right: 20px;
            flex-shrink: 0;
        }
        
        .profile-info {
            flex: 1;
        }
        
        .profile-info h2 {
            margin: 0 0 5px 0;
            color: #2c3e50;
            font-size: 1.5rem;
        }
        
        .profile-info p {
            margin: 3px 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        .profile-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .profile-section h3 {
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        
        .detail-row {
            display: flex;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .detail-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .detail-label {
            font-weight: 600;
            color: #555;
            width: 180px;
            flex-shrink: 0;
            font-size: 0.9rem;
        }
        
        .detail-value {
            color: #333;
            flex-grow: 1;
            font-size: 0.95rem;
        }
        
        .status-active,
        .status-inactive {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-active {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status-inactive {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .class-selection-panel {
            flex: 1;
            min-width: 350px;
            max-width: 400px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .section-header {
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .section-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.5em;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        
        .alert.error {
            background-color: #fdecea;
            color: #c62828;
            border-left: 4px solid #c62828;
        }
        
        .alert.success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border-left: 4px solid #2e7d32;
        }
        
        .student-list-container {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .student-list-container h3 {
            margin: 0 0 15px 0;
            color: #444;
            font-size: 1.1em;
        }
        
        .student-list {
            flex: 1;
            overflow-y: auto;
            margin: 0 -10px;
            padding: 0 10px;
        }
        
        .student-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .student-item:hover {
            background-color: #f5f5f5;
            border-color: #d0d0d0;
        }
        
        .student-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e3f2fd;
            color: #1976d2;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .student-info {
            flex: 1;
            min-width: 0;
        }
        
        .student-info h4 {
            margin: 0 0 4px 0;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .student-info p {
            margin: 0;
            font-size: 13px;
            color: #666;
        }
        
        .student-profile-panel {
            flex: 2;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 25px;
            min-height: 500px;
        }
        
        .empty-state,
        .empty-profile {
            text-align: center;
            color: #9e9e9e;
            padding: 40px 20px;
        }
        
        .empty-state i,
        .empty-profile i {
            font-size: 48px;
            color: #e0e0e0;
            margin-bottom: 15px;
            display: block;
        }
        
        .empty-state p,
        .empty-profile p {
            margin: 10px 0 0;
            font-size: 1.1em;
        }
                flex-direction: column;
            }
            
            .class-selection-panel {
                max-width: 100%;
            }
            
            .student-profile-panel {
                margin-top: 20px;
            }
        }
        
        .return-book-btn {
            background-color: #10b981;
            color: white;
            border: none;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .return-book-btn:hover {
            background-color: #059669;
        }
        
        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            max-width: 350px;
        }
        
        .notification {
            position: relative;
            padding: 15px 20px;
            margin-bottom: 10px;
            border-radius: 4px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            opacity: 0.95;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification.success {
            background-color: #2ecc71;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.warning {
            background-color: #f39c12;
        }
        
        .notification.info {
            background-color: #3498db;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0 0 0 15px;
            line-height: 1;
        }
        
        .notification.fade-out {
            opacity: 0;
            transform: translateX(100%);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 9999; /* Very high z-index */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            overflow-y: auto;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .modal.show {
            display: block;
            opacity: 1;
            visibility: visible;
        }
        
        .profile-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .profile-section h3 {
            color: #2c3e50;
            margin: 0 0 15px 0;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 10px;
        }
        
        .profile-details {
            margin-top: 10px;
        }
        
        .profile-details p {
            margin: 8px 0;
            color: #333;
        }
        
        .profile-details strong {
            color: #2c3e50;
            font-weight: 600;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            position: relative;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(-50px);
            opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            z-index: 10000; /* Higher than modal overlay */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .show .modal-content {
            transform: translateY(0);
            opacity: 1;
        }
        .registration-page {
            padding: 20px;
            text-align: center;
        }
        .add-learner-btn {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.3s;
        }
        .add-learner-btn:hover {
            background-color: #45a049;
        }
        .add-teacher-btn {
            background-color: #2196F3;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
            transition: background-color 0.3s;
        }
        .add-teacher-btn:hover {
            background-color: #1976D2;
        }
        .close {
            position: absolute;
            right: 10px;
            top: 5px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: #f44336;
        }
        .student-item {
            background: white;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .student-item h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .students-container, .teachers-container {
            margin-top: 2rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .students-container h3, .teachers-container h3 {
            color: #2c3e50;
            margin: 0 0 1rem 0;
            font-size: 1.2rem;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 0.5rem;
        }

        .students-list, .teachers-list {
            display: grid;
            gap: 1rem;
        }

        .class-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .class-title {
            color: #2c3e50;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            border-bottom: 2px solid #2c3e50;
            padding-bottom: 0.5rem;
        }

        .students-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }

        .action-buttons {
            margin-top: 1rem;
        }

        .action-buttons button {
            margin-right: 0.5rem;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .action-buttons button:first-child {
            background: #4CAF50;
            color: white;
        }

        .action-buttons button:last-child {
            background: #f44336;
            color: white;
        }
    </style>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom Styles -->
    <style>
        /* Main Content Styling */
        .main-content header {
            margin-bottom: 2rem;
        }
        
        .main-content h1 {
            color: var(--gray-800);
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--gray-100);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-800);
            margin: 0;
        }
        
        .card-body {
            padding: 1.5rem;
        }
        
        /* Responsive Grid */
        @media (min-width: 1024px) {
            .content-grid {
                grid-template-columns: 2fr 1fr;
            }
        }
        
        /* Utility Classes */
        .text-muted {
            color: var(--gray-500);
        }
        
        .text-primary {
            color: var(--primary);
        }
        
        .bg-primary-light {
            background-color: rgba(79, 70, 229, 0.1);
        }
    </style>
</head>

<body>
    <!-- Notification Container -->
    <div id="notification-container" class="notification-container"></div>
    
    <button class="sidebar-toggle" aria-label="Toggle sidebar">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-logo">
            <div class="logo-icon">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <h2>SchoolSync</h2>
        </div>
        <div class="sidebar-profile">
            <div class="profile-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="profile-info">
                <div class="profile-name">Admin User</div>
            </div>
        </div>
        <div class="divider"></div>
        <ul class="sidebar-menu">
            <li class="tab-link active" data-tab="dashboard-section">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </li>
            <li class="tab-link" data-tab="registration-section">
                <i class="fas fa-user-plus"></i>
                <span>Registration</span>
            </li>
            <li class="tab-link" data-tab="user-management-section">
                <i class="fas fa-users-cog"></i>
                <span>User Management</span>
            </li>
            <li class="tab-link" data-tab="student-management-section">
                <i class="fas fa-user-graduate"></i>
                <span>Students</span>
            </li>
            <li class="tab-link" data-tab="clubs-section">
                <i class="fas fa-flag"></i>
                <span>Clubs</span>
            </li>
            <li class="tab-link" data-tab="library-section">
                <i class="fas fa-book"></i>
                <span>Library</span>
            </li>
            <li class="tab-link" data-tab="accountant-section">
                <i class="fas fa-calculator"></i>
                <span>Finance</span>
            </li>
            <li class="tab-link" data-tab="events-section">
                <i class="fas fa-clipboard-check"></i>
                <span>Attendance</span>
            </li>
            <li class="tab-link" data-tab="backup-section">
                <i class="fas fa-database"></i>
                <span>Backup</span>
            </li>
            <li class="tab-link" data-tab="role-management-section">Role Management</li>
            <li class="tab-link" data-tab="quizzes-section" onclick="window.location.href='quizzes.html'">Quizzes</li>
            <li class="tab-link" data-tab="logout-section" onclick="window.location.href='http://localhost:8000/pages/login'">Logout</li>
        </ul>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <header>
            <h1>Welcome back, Admin</h1>
        </header>


        <!-- Notifications Section (Broadcast Communication) -->
        <section id="notifications-section" class="form-section tab-section" style="display:none;">
            <h2>Broadcast Communication</h2>
            <form id="broadcast-form">
                <div class="form-group">
                    <label for="broadcast-target">Target Audience:</label>
                    <select id="broadcast-target" required>
                        <option value="all">All Users</option>
                        <option value="teachers">Teachers</option>
                        <option value="students">Students</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="broadcast-title">Title:</label>
                    <input type="text" id="broadcast-title" placeholder="Message Title" required>
                </div>
                <div class="form-group">
                    <label for="broadcast-message">Message:</label>
                    <textarea id="broadcast-message" placeholder="Enter your message here..." rows="4" required></textarea>
                </div>
                <button type="submit">Send Broadcast</button>
            </form>
            <div id="broadcast-log">
                <h3>Broadcast Log</h3>
                <ul id="broadcast-log-list"></ul>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="registration-section" class="tab-section" style="display:none;">
            <div class="registration-page">
                <h2>Registration Management</h2>
                
                <!-- Registration Tabs -->
                <div class="registration-tabs">
                    <button class="tab-btn active" onclick="showTab('students-tab')">Students</button>
                    <button class="tab-btn" onclick="showTab('teachers-tab')">Teachers</button>
                </div>

                <!-- Registration Buttons -->
                <div class="registration-buttons">
                    <button class="add-learner-btn" onclick="openRegistrationModal('student')">
                        Add Learner
                    </button>
                    <button class="add-teacher-btn" onclick="openRegistrationModal('teacher')">
                        Add Teacher
                    </button>
                </div>

                <!-- Students Table -->
                <div id="students-tab" class="tab-content active">
                    <h3>Students List</h3>
                    <div class="table-container">
                        <table id="students-table" class="registration-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Class</th>
                                    <th>Gender</th>
                                    <th>Date of Birth</th>
                                    <th>Emergency Contact</th>
                                    <th>Health Info</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="students-tbody">
                                <!-- Students will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Teachers Table -->
                <div id="teachers-tab" class="tab-content">
                    <h3>Teachers List</h3>
                    <div class="table-container">
                        <table id="teachers-table" class="registration-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Specialization</th>
                                    <th>Gender</th>
                                    <th>Emergency Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teachers-tbody">
                                <!-- Teachers will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Registration Modal -->
        <div id="registrationModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeRegistrationModal()">&times;</span>
                <h2 id="modal-title">Student Registration</h2>
                <form id="registration-form" class="form-container">
                    <!-- Basic Information -->
                    <div class="form-group">
                        <h3>Basic Information</h3>
                        <div class="form-group">
                            <label for="name">Full Name:</label>
                            <input type="text" id="name" name="name" placeholder="Enter full name" required>
                            <input type="date" id="dob" name="dob" required>
                        </div>
                        <!-- Class Selection (for students) -->
                        <div id="class-selection" class="form-group" style="display: none;">
                            <label for="student-class">Class:</label>
                            <select id="student-class" name="studentClass" required>
                                <option value="">Select Class</option>
                                <!-- Pre-Primary (2 years) -->
                                <optgroup label="Pre-Primary">
                                    <option value="pp1">Pre-Primary 1 (PP1) - Age 4-5</option>
                                    <option value="pp2">Pre-Primary 2 (PP2) - Age 5-6</option>
                                </optgroup>
                                
                                <!-- Primary Education (8 years) -->
                                <optgroup label="Primary Education">
                                    <option value="grade1">Grade 1 - Age 6-7</option>
                                    <option value="grade2">Grade 2 - Age 7-8</option>
                                    <option value="grade3">Grade 3 - Age 8-9</option>
                                    <option value="grade4">Grade 4 - Age 9-10</option>
                                    <option value="grade5">Grade 5 - Age 10-11</option>
                                    <option value="grade6">Grade 6 - Age 11-12</option>
                                    <option value="grade7">Grade 7 - Age 12-13</option>
                                    <option value="grade8">Grade 8 - Age 13-14 (KCPE)</option>
                                </optgroup>
                                
                                <!-- Secondary Education (4 years) -->
                                <optgroup label="Secondary Education">
                                    <option value="form1">Form 1 - Age 14-15</option>
                                    <option value="form2">Form 2 - Age 15-16</option>
                                    <option value="form3">Form 3 - Age 16-17</option>
                                    <option value="form4">Form 4 - Age 17-18 (KCSE)</option>
                                </optgroup>
                                
                                <!-- Tertiary/College (Optional) -->
                                <optgroup label="Tertiary/College">
                                    <option value="college1">Year 1 - Certificate/Diploma</option>
                                    <option value="college2">Year 2 - Certificate/Diploma</option>
                                    <option value="college3">Year 3 - Diploma/Degree</option>
                                    <option value="college4">Year 4 - Degree</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gender">Gender:</label>
                            <select id="gender" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="email">Email:</label>
                            <input type="email" id="email" name="email" placeholder="Enter email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Password:</label>
                            <div class="password-input-container">
                                <input type="password" id="password" name="password" placeholder="Enter password" required>
                                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="confirm-password">Confirm Password:</label>
                            <div class="password-input-container">
                                <input type="password" id="confirm-password" name="confirmPassword" placeholder="Confirm password" required>
                                <button type="button" class="toggle-password" aria-label="Toggle password visibility">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small id="password-match-error" style="color: red; display: none;">Passwords do not match</small>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone:</label>
                            <input type="tel" id="phone" name="phone" placeholder="Enter phone number" required>
                        </div>
                        <div class="form-group">
                            <label for="address">Address:</label>
                            <textarea id="address" name="address" placeholder="Enter address" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- Teacher Specific Fields -->
                    <div id="teacher-fields" style="display: none;">
                        <h3>Teacher Information</h3>
                        <div class="form-group">
                            <label for="specialization">Specialization:</label>
                            <input type="text" id="specialization" name="specialization" placeholder="Enter specialization">
                        </div>
                    </div>

                    <!-- Emergency Contact -->
                    <div class="form-group">
                        <h3>Emergency Contact</h3>
                        <div class="form-group">
                            <label for="emergency-name">Name:</label>
                            <input type="text" id="emergency-name" name="emergencyContactName" placeholder="Emergency contact name" required>
                        </div>
                        <div class="form-group">
                            <label for="emergency-phone">Phone:</label>
                            <input type="tel" id="emergency-phone" name="emergencyContactPhone" placeholder="Emergency contact phone" required>
                        </div>
                        <div class="form-group">
                            <label for="emergency-relationship">Relationship:</label>
                            <input type="text" id="emergency-relationship" name="emergencyContactRelationship" placeholder="Relationship to user" required>
                        </div>
                    </div>

                    <!-- Health Information -->
                    <div class="form-group">
                        <h3>Health Information</h3>
                        <div class="form-group">
                            <label for="blood-group">Blood Group:</label>
                            <select id="blood-group" name="bloodGroup">
                                <option value="">Select Blood Group</option>
                                <option value="A+">A+</option>
                                <option value="A-">A-</option>
                                <option value="B+">B+</option>
                                <option value="B-">B-</option>
                                <option value="AB+">AB+</option>
                                <option value="AB-">AB-</option>
                                <option value="O+">O+</option>
                                <option value="O-">O-</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="allergies">Allergies:</label>
                            <textarea id="allergies" name="allergies" placeholder="List any known allergies" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="medical-conditions">Medical Conditions:</label>
                            <textarea id="medical-conditions" name="medicalConditions" placeholder="List any medical conditions" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="medications">Current Medications:</label>
                            <textarea id="medications" name="medications" placeholder="List any current medications" rows="2"></textarea>
                        </div>
                    </div>

                    <button type="submit" class="submit-btn">Register</button>
                </form>
            </div>
        </div>
    </div>

        <!-- Dashboard Section -->
        <section id="dashboard-section" class="tab-section" style="display:block; padding: 15px;">
            <div class="dashboard-header">
                <h1>Dashboard</h1>
            </div>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <!-- Students -->
                <div class="stat-card">
                    <h3><i class="fas fa-user-graduate"></i> Students</h3>
                    <div class="stat-value" id="student-count">0</div>
                    <div class="stat-trend">Total enrolled</div>
                </div>

                <!-- Teachers -->
                <div class="stat-card">
                    <h3><i class="fas fa-chalkboard-teacher"></i> Teachers</h3>
                    <div class="stat-value" id="teacher-count">0</div>
                    <div class="stat-trend">Staff members</div>
                </div>

                <!-- Attendance -->
                <div class="stat-card">
                    <h3><i class="fas fa-calendar-check"></i> Attendance</h3>
                    <div class="attendance-stats">
                        <div class="attendance-stat">
                            <span class="stat-value" id="today-present">0</span>
                            <span class="stat-label">Present</span>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: 0%" id="present-percentage"></div>
                            </div>
                        </div>
                        <div class="attendance-stat">
                            <span class="stat-value" id="today-absent">0</span>
                            <span class="stat-label">Absent</span>
                            <div class="progress">
                                <div class="progress-bar bg-danger" style="width: 0%" id="absent-percentage"></div>
                            </div>
                        </div>
                    </div>
                    <small id="attendance-date" class="text-muted"></small>
                </div>

                <!-- Library -->
                <div class="stat-card">
                    <h3><i class="fas fa-book"></i> Library</h3>
                    <div class="stat-value" id="book-count">0</div>
                    <div class="stat-value" style="font-size: 1.1rem; color: #2196F3;" id="issued-books-count">Issued: 0</div>
                    <div class="stat-trend">Books Management</div>
                </div>

                <!-- Clubs -->
                <div class="stat-card">
                    <h3><i class="fas fa-users"></i> Clubs</h3>
                    <div class="stat-value" id="club-count">0</div>
                    <div class="stat-trend">Active clubs</div>
                </div>

                <!-- Fees -->
                <div class="stat-card">
                    <h3><i class="fas fa-money-bill-wave"></i> Fees</h3>
                    <div class="stat-value" id="fee-count">Ksh 0</div>
                    <div class="stat-value" style="font-size: 1.1rem; color: #2196F3;" id="fee-paid">Paid: Ksh 0</div>
                    <div class="stat-value" style="font-size: 1.1rem;" id="fee-balance">Balance: Ksh 0</div>
                    <div class="stat-trend" id="fee-summary">This term</div>
                </div>
            </div>
        </section>
            </div>

        <!-- User Management Section (Enhanced) -->
        <section id="user-management-section" class="tab-section" style="display:none;">
            <h2>User Management</h2>
            <div class="form-container">
                <h3>Add New User</h3>
                <form id="add-user-form">
                    <input type="text" id="user-name" placeholder="Full Name" required>
                    <input type="email" id="user-email" placeholder="Email" required>
                    <input type="text" id="user-username" placeholder="Username" required>
                    <input type="password" id="user-password" placeholder="Password" required>
                    <select id="user-role" required>
                        <option value="Student">Student</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Admin">Admin</option>
                        <option value="Accountant">Accountant</option>
                        <option value="Parent">Parent</option>
                    </select>
                    <input type="text" id="user-subject" placeholder="Subject (Teachers only)" style="display:none;">
                    <input type="text" id="user-class" placeholder="Class (Students only)" style="display:none;">
                    <button type="submit">Add User</button>
                </form>
                <div id="user-add-msg" style="display:none;margin-top:8px;"></div>
            </div>
            <div class="form-container">
                <h3>All Users</h3>
                <!-- Advanced Filters for Users -->
                <div class="flex flex-wrap gap-2 mb-2" id="user-filters">
                    <input type="text" id="user-search" placeholder="Search by name, email, or username" class="border px-2 py-1 rounded">
                    <select id="user-role-filter" class="border px-2 py-1 rounded">
                        <option value="">All Roles</option>
                        <option value="Admin">Admin</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Student">Student</option>
                        <option value="Accountant">Accountant</option>
                        <option value="Parent">Parent</option>
                    </select>
                    <select id="user-status-filter" class="border px-2 py-1 rounded">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Inactive">Inactive</option>
                        <option value="Suspended">Suspended</option>
                    </select>
                </div>
                <button id="user-export-btn">Export Users (CSV)</button>
                <div id="users-bulk-toolbar" style="display:none; margin-bottom: 10px;">
                    <button id="users-bulk-delete" disabled>Delete Selected</button>
                    <button id="users-bulk-export" disabled>Export Selected</button>
                </div>
                <table id="user-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all-users"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="user-table-body">
                        <!-- User rows will be rendered here (with checkboxes) -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Class Management Section -->
        <section id="student-management-section" class="tab-section" style="display:none;">
            <div class="class-management-container">
                <!-- Class Selection Panel -->
                <div class="class-selection-panel">
                    <div class="section-header">
                        <h2>Class Management</h2>
                    </div>
                    
                    <!-- Status Message -->
                    <div id="class-message" class="alert" style="display: none;"></div>
                    
                    <!-- Class Dropdown -->
                    <div class="form-group">
                        <label for="class-select">
                            <i class="fas fa-chalkboard-teacher"></i> Select Class
                        </label>
                        <select id="class-select" class="form-control">
                            <option value="">-- Select a class --</option>
                            <optgroup label="Primary School">
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                            </optgroup>
                            <optgroup label="Secondary School">
                                <option value="Form 1">Form 1</option>
                                <option value="Form 2">Form 2</option>
                                <option value="Form 3">Form 3</option>
                                <option value="Form 4">Form 4</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <!-- Student List -->
                    <div class="student-list-container">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">Students</h3>
                            <button id="add-student-btn" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus"></i> Add Student
                            </button>
                        </div>
                        <div id="student-list" class="student-list">
                            <div class="empty-state">
                                <i class="fas fa-user-graduate"></i>
                                <p>Select a class to view students</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Student Profile Panel -->
                <div class="student-profile-panel">
                    <div id="student-profile">
                        <div class="empty-profile">
                            <i class="fas fa-user-graduate"></i>
                            <p>Select a student to view profile</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- New: System Entities Management Section -->
        <section id="entities-section" class="tab-section" style="display:none;">
            <h2>System Entities Management</h2>
            <div class="form-container">
                <h3>Add New Class</h3>
                <form id="add-class-form">
                    <input type="text" id="class-name" placeholder="Class Name" required>
                    <input type="text" id="class-teacher" placeholder="Assigned Teacher" required>
                    <button type="submit">Add Class</button>
                </form>
                <h3>Add New Subject</h3>
                <form id="add-subject-form">
                    <input type="text" id="subject-name" placeholder="Subject Name" required>
                    <input type="text" id="subject-code" placeholder="Subject Code" required>
                    <button type="submit">Add Subject</button>
                </form>
            </div>
            <div class="entity-list">
                <h3>Classes</h3>
                <ul id="class-list"></ul>
                <h3>Subjects</h3>
                <ul id="subject-list"></ul>
            </div>
        </section>
        <section id="clubs-section" class="tab-section p-6 max-w-3xl mx-auto" style="display:none;">
            <h2 class="text-2xl font-bold mb-4">Manage Clubs</h2>

            <!-- Add Club Form -->
            <form id="club-form" class="bg-white p-4 rounded shadow space-y-3 mb-4">
                <input type="text" id="club-name" class="w-full border px-3 py-2 rounded" placeholder="Club Name" required />
                <input type="text" id="club-description" class="w-full border px-3 py-2 rounded" placeholder="Description" required />
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Club</button>
            </form>

            <!-- Bulk Actions Toolbar for Clubs -->
            <div id="clubs-bulk-toolbar" style="display:none; margin-bottom: 10px;">
                <button id="clubs-bulk-delete" disabled>Delete Selected</button>
                <button id="clubs-bulk-export">Export</button>
            </div>
            <input type="text" id="club-search" placeholder="Search clubs..." class="mb-4 p-2 w-full border rounded" />
            <select id="club-type-filter" class="mb-4 p-2 w-full border rounded">
                <option value="">All Types</option>
                <option value="sports">Sports</option>
                <option value="academic">Academic</option>
                <option value="arts">Arts</option>
            </select>
            <div class="overflow-x-auto">
                <ul id="club-list" class="divide-y divide-gray-200"></ul>
            </div>
        </section>

        <!-- Library Section (Modernized) -->
        <section id="library-section" class="tab-section" style="display:none;">
            <h2>Library Management</h2>
            
            <!-- Library Tabs -->
            <div class="library-tabs">
                <button class="tab-btn active" onclick="showLibraryTab('available-books')">Available Books</button>
                <button class="tab-btn" onclick="showLibraryTab('issued-books')">Issued Books</button>
            </div>
            
            <!-- Available Books Tab -->
            <div id="available-books" class="library-tab-content active">
                <div id="library-bulk-toolbar" style="display:none; margin-bottom: 10px;">
                    <button id="library-bulk-delete" disabled>Delete Selected</button>
                    <button id="library-bulk-export" disabled>Export Selected</button>
                </div>
            <div class="form-container">
                <h3>Add New Book</h3>
                <form id="library-form">
                    <input type="text" id="book-title" placeholder="Book Title" required>
                    <input type="text" id="book-author" placeholder="Author" required>
                    <input type="number" id="book-year" placeholder="Publication Year" min="1000" max="2099" value="2025">
                    <select id="book-class" required>
                        <option value="">Select Class</option>
                        <optgroup label="Pre-Primary">
                            <option value="PP1">PP1</option>
                            <option value="PP2">PP2</option>
                        </optgroup>
                        <optgroup label="Lower Primary">
                            <option value="Grade 1">Grade 1</option>
                            <option value="Grade 2">Grade 2</option>
                            <option value="Grade 3">Grade 3</option>
                        </optgroup>
                        <optgroup label="Upper Primary">
                            <option value="Grade 4">Grade 4</option>
                            <option value="Grade 5">Grade 5</option>
                            <option value="Grade 6">Grade 6</option>
                        </optgroup>
                        <optgroup label="Junior Secondary">
                            <option value="Grade 7">Grade 7</option>
                            <option value="Grade 8">Grade 8</option>
                            <option value="Grade 9">Grade 9</option>
                        </optgroup>
                        <optgroup label="Senior School">
                            <option value="Grade 10">Grade 10</option>
                            <option value="Grade 11">Grade 11</option>
                            <option value="Grade 12">Grade 12</option>
                        </optgroup>
                    </select>
                    <select id="book-status" required>
                        <option value="available">Available</option>
                        <option value="checked-out">Checked Out</option>
                        <option value="lost">Lost</option>
                    </select>
                    <input type="number" id="book-copies" placeholder="Number of Copies" min="1" value="1" required>
                    <button type="submit">Add Book</button>
                </form>
            </div>
                <div class="form-container">
                    <h3>All Books</h3>
                    <!-- Advanced Filters for Library -->
                    <div class="flex flex-wrap gap-2 mb-2" id="library-filters">
                        <input type="text" id="library-search" placeholder="Search by title, author, or description" class="border px-2 py-1 rounded">
                        <select id="library-genre-filter" class="border px-2 py-1 rounded">
                            <option value="">All Genres</option>
                            <option value="Fiction">Fiction</option>
                            <option value="Non-Fiction">Non-Fiction</option>
                            <option value="Science">Science</option>
                            <option value="History">History</option>
                            <option value="Biography">Biography</option>
                            <option value="Children">Children</option>
                            <option value="Other">Other</option>
                        </select>
                        <select id="library-class-filter" class="border px-2 py-1 rounded">
                            <option value="">All Classes</option>
                            <optgroup label="Pre-Primary">
                                <option value="PP1">PP1</option>
                                <option value="PP2">PP2</option>
                            </optgroup>
                            <optgroup label="Lower Primary">
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                            </optgroup>
                            <optgroup label="Upper Primary">
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                            </optgroup>
                            <optgroup label="Junior Secondary">
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </optgroup>
                            <optgroup label="Senior School">
                                <option value="Grade 10">Grade 10</option>
                                <option value="Grade 11">Grade 11</option>
                                <option value="Grade 12">Grade 12</option>
                            </optgroup>
                        </select>
                        <input type="text" id="library-author-filter" placeholder="Author" class="border px-2 py-1 rounded">
                        <button type="button" id="reset-library-filters" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded">
                            Reset Filters
                        </button>
                    </div>
                    <table id="library-table" class="data-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="select-all-library"></th>
                                <th>Title</th>
                                <th>Author</th>
                                <th>Year</th>
                                <th>Genre</th>
                                <th>Status</th>
                                <th>Copies</th>
                                <th>Available</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="library-table-body">
                            <!-- Book rows will be rendered here (with checkboxes) -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Issued Books Tab -->
            <div id="issued-books" class="library-tab-content">
                <div class="form-container">
                    <h3>Issued Books</h3>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" id="issued-books-search" placeholder="Search issued books..." class="form-control">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select id="classFilter" class="form-select">
                                <option value="">All Classes</option>
                                <optgroup label="Pre-Primary">
                                    <option value="Baby Class">Baby Class</option>
                                    <option value="PP1">PP1</option>
                                    <option value="PP2">PP2</option>
                                </optgroup>
                                <optgroup label="Lower Primary">
                                    <option value="Grade 1">Grade 1</option>
                                    <option value="Grade 2">Grade 2</option>
                                    <option value="Grade 3">Grade 3</option>
                                </optgroup>
                                <optgroup label="Upper Primary">
                                    <option value="Grade 4">Grade 4</option>
                                    <option value="Grade 5">Grade 5</option>
                                    <option value="Grade 6">Grade 6</option>
                                </optgroup>
                                <optgroup label="Junior Secondary">
                                    <option value="Grade 7">Grade 7</option>
                                    <option value="Grade 8">Grade 8</option>
                                    <option value="Grade 9">Grade 9</option>
                                </optgroup>
                                <optgroup label="Senior School">
                                    <option value="Grade 10">Grade 10</option>
                                    <option value="Grade 11">Grade 11</option>
                                    <option value="Grade 12">Grade 12</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="resetFilters" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-sync-alt me-1"></i> Reset
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="issued-books-table" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Book Title</th>
                                <th>Borrower Name</th>
                                <th>Class</th>
                                <th>Issue Date</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="issued-books-list">
                            <!-- Issued books will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Accountant Section (Modernized) -->
        <section id="accountant-section" class="tab-section" style="display:none;">
            <h2>Accountant / Fee Management</h2>
            <div id="fees-bulk-toolbar" style="display:none; margin-bottom: 10px;">
                <button id="fees-bulk-delete" disabled>Delete Selected</button>
                <button id="fees-bulk-export" disabled>Export Selected</button>
            </div>
            <div class="form-container">
                <h3>Add Fee Record</h3>
                <form id="fee-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="fee-class-name">Class</label>
                        <select id="fee-class-name" class="w-full p-2 border rounded" required>
                            <option value="">Select a class</option>
                            <!-- Classes will be populated by JavaScript -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fee-student-id">Student</label>
                        <select id="fee-student-id" class="w-full p-2 border rounded" required disabled>
                            <option value="">Select a class first</option>
                            <!-- Students will be populated based on class selection -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fee-fees-per-term">Fees Per Term (Ksh)</label>
                        <input type="number" id="fee-fees-per-term" class="w-full" placeholder="Total fees per term" required>
                    </div>
                    <div class="form-group">
                        <label for="fee-first-installment">1st Installment (Ksh)</label>
                        <div class="flex gap-2">
                            <input type="number" id="fee-first-installment" class="flex-1" placeholder="Amount">
                            <input type="date" id="fee-first-installment-date" class="w-40">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fee-second-installment">2nd Installment (Ksh)</label>
                        <div class="flex gap-2">
                            <input type="number" id="fee-second-installment" class="flex-1" placeholder="Amount">
                            <input type="date" id="fee-second-installment-date" class="w-40">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fee-third-installment">3rd Installment (Ksh)</label>
                        <div class="flex gap-2">
                            <input type="number" id="fee-third-installment" class="flex-1" placeholder="Amount">
                            <input type="date" id="fee-third-installment-date" class="w-40">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="fee-bal">Balance (Ksh)</label>
                        <input type="number" id="fee-bal" class="w-full" placeholder="Current balance" required>
                    </div>
                    <div class="form-group">
                        <label for="fee-due-date">Due Date</label>
                        <input type="date" id="fee-due-date" class="w-full" required>
                    </div>
                    <div class="form-group">
                        <label for="fee-academic-year">Academic Year</label>
                        <select id="fee-academic-year" class="w-full p-2 border rounded" required>
                            <option value="">Select Academic Year</option>
                            <option value="2024/2025">2024/2025</option>
                            <option value="2023/2024">2023/2024</option>
                            <option value="2022/2023">2022/2023</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="fee-academic-term">Academic Term</label>
                        <select id="fee-academic-term" class="w-full p-2 border rounded" required>
                            <option value="">Select Term</option>
                            <option value="Term 1">Term 1</option>
                            <option value="Term 2">Term 2</option>
                            <option value="Term 3">Term 3</option>
                        </select>
                    </div>
                    <div class="form-group md:col-span-2">
                        <label for="fee-notes">Notes</label>
                        <textarea id="fee-notes" class="w-full" rows="2" placeholder="Any additional notes"></textarea>
                    </div>
                    <div class="form-group md:col-span-2 flex gap-4">
                        <button type="submit" class="btn btn-primary flex-1">
                            <i class="fas fa-save mr-2"></i>Save Fee Record
                        </button>
                        <button type="button" id="print-receipt-btn" class="btn btn-secondary flex-1" disabled>
                            <i class="fas fa-print mr-2"></i>Print Receipt
                        </button>
                    </div>
                </form>
            </div>
            <div class="form-container">
                <h3>All Fee Records</h3>
                <!-- Advanced Filters for Fees -->
                <div class="flex flex-wrap gap-3 mb-4" id="fees-filters">
                    <div class="relative flex-1 min-w-[200px]">
                        <input type="text" id="fees-search" placeholder="Search by student or class" class="w-full border px-3 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    
                    <div class="relative">
                        <select id="fees-status-filter" class="border px-3 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">All Statuses</option>
                            <option value="Paid">Paid</option>
                            <option value="Pending">Pending</option>
                            <option value="Overdue">Overdue</option>
                        </select>
                    </div>
                    
                    <div class="relative">
                        <select id="fees-class-filter" class="border px-3 py-2 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent min-w-[180px]">
                            <option value="">All Classes</option>
                            <optgroup label="Pre-Primary">
                                <option value="Baby Class">Baby Class</option>
                                <option value="PP1">PP1</option>
                                <option value="PP2">PP2</option>
                            </optgroup>
                            <optgroup label="Lower Primary">
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                            </optgroup>
                            <optgroup label="Upper Primary">
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Grade 6">Grade 6</option>
                            </optgroup>
                            <optgroup label="Junior Secondary">
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="Grade 9">Grade 9</option>
                            </optgroup>
                            <optgroup label="Senior School">
                                <option value="Grade 10">Grade 10</option>
                                <option value="Grade 11">Grade 11</option>
                                <option value="Grade 12">Grade 12</option>
                            </optgroup>
                        </select>
                    </div>
                    
                    <button id="reset-filters" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
                        <i class="fas fa-sync-alt mr-1"></i> Reset Filters
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <table id="fee-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    <input type="checkbox" id="select-all-fees" class="rounded text-blue-600">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Student</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Fees</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fee-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Fee rows will be rendered here (with checkboxes) -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Attendance Management Section -->
        <section id="events-section" class="tab-section" style="display:none; padding: 20px;">
            <h2>Attendance Management</h2>
            
            <!-- Date Range Selection -->
            <div class="form-section mb-4">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="attendance-class-filter">
                                <i class="fas fa-chalkboard-teacher"></i> Select Class
                            </label>
                            <select id="attendance-class-filter" class="form-control">
                                <option value="">All Classes</option>
                                <optgroup label="Primary School">
                                    <option value="Grade 1">Grade 1</option>
                                    <option value="Grade 2">Grade 2</option>
                                    <option value="Grade 3">Grade 3</option>
                                    <option value="Grade 4">Grade 4</option>
                                    <option value="Grade 5">Grade 5</option>
                                    <option value="Grade 6">Grade 6</option>
                                    <option value="Grade 7">Grade 7</option>
                                    <option value="Grade 8">Grade 8</option>
                                </optgroup>
                                <optgroup label="Secondary School">
                                    <option value="Form 1">Form 1</option>
                                    <option value="Form 2">Form 2</option>
                                    <option value="Form 3">Form 3</option>
                                    <option value="Form 4">Form 4</option>
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="start-date-filter">
                                <i class="far fa-calendar-alt"></i> Start Date
                            </label>
                            <input type="date" id="start-date-filter" class="form-control">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label for="end-date-filter">
                                <i class="far fa-calendar-alt"></i> End Date
                            </label>
                            <div class="input-group">
                                <input type="date" id="end-date-filter" class="form-control">
                                <div class="input-group-append">
                                    <button id="filter-attendance-btn" class="btn btn-primary">
                                        <i class="fas fa-search"></i> Filter
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Summary -->
            <div id="attendance-summary-cards" class="row mb-4" style="display: none;">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Total Students</h5>
                            <h2 id="total-students">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Present</h5>
                            <h2 id="total-present">0</h2>
                            <small id="present-percentage">0%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-danger text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Absent</h5>
                            <h2 id="total-absent">0</h2>
                            <small id="absent-percentage">0%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body text-center">
                            <h5 class="card-title">Average Attendance</h5>
                            <h2 id="avg-attendance">0%</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Attendance Records Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Attendance Records</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="attendance-records-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Class</th>
                                    <th>Present</th>
                                    <th>Absent</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="attendance-records-body">
                                <!-- Records will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Attendance Details Modal -->
            <div class="modal fade" id="attendanceDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Attendance Details - <span id="modal-date"></span></h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="table-responsive">
                                <table class="table table-bordered">
                                    <thead class="thead-light">
                                        <tr>
                                            <th>Student Name</th>
                                            <th>Status</th>
                                            <th>Remarks</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attendance-details-body">
                                        <!-- Details will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Actions Toolbar for Events -->
            <div id="events-bulk-toolbar" style="display:none; margin-bottom: 10px;">
                <button id="events-bulk-delete" disabled>Delete Selected</button>
                <button id="events-bulk-export">Export</button>
            </div>
            <input type="text" id="events-search" placeholder="Search events..." class="mb-4 p-2 w-full border rounded" />
            <select id="events-type-filter" class="mb-4 p-2 w-full border rounded">
                <option value="">All Types</option>
                <option value="sports">Sports</option>
                <option value="academic">Academic</option>
                <option value="arts">Arts</option>
            </select>
            <input type="date" id="events-date-filter" class="mb-4 p-2 w-full border rounded" />
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Title</th>
                            <th>Description</th>
                            <th>Date</th>
                            <th>Location</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="event-list"></tbody>
                </table>
            </div>
        </section>

        <!-- Backup Section (Modernized) -->
        <section id="backup-section" class="tab-section" style="display:none;">
            <h2>Backup & Restore</h2>
            <div class="form-container">
                <button id="backup-now-btn">Backup Now</button>
            </div>
            <div class="form-container">
                <h3>Available Backups</h3>
                <ul id="backup-list"></ul>
            </div>
        </section>

        <!-- Registration Section -->
        <section id="registration-section" class="tab-section" style="display:none;">
            <h2>Registration</h2>
            <div class="form-container">
                <button class="add-learner-btn" onclick="openRegistrationModal('student')">Add Student</button>
                <button class="add-teacher-btn" onclick="openRegistrationModal('teacher')">Add Teacher</button>
            </div>
            
            <!-- Students List Container -->
            <div class="students-container">
                <h3>Students</h3>
                <div id="students-list" class="students-list">
                    <!-- Students will be loaded here -->
                </div>
            </div>

            <!-- Teachers List Container -->
            <div class="teachers-container">
                <h3>Teachers</h3>
                <div id="teachers-list" class="teachers-list">

        <!-- Logout Section -->
        <section id="logout-section" class="tab-section" style="display:none;">
            <h2>You are logged out!</h2>
            <button onclick="window.location.href='login.html'">Go to Login Page</button>
        </section>
    </main>

    <!-- Club Members Modal -->
    <div id="club-members-modal" class="modal" style="
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    ">
        <div class="modal-content" style="
            background-color: #ffffff;
            margin: 5% auto;
            padding: 25px;
            border: none;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        ">
            <span class="close" onclick="closeClubMembersModal()" style="
                position: absolute;
                right: 20px;
                top: 15px;
                font-size: 28px;
                font-weight: bold;
                color: #666;
                cursor: pointer;
                transition: color 0.2s ease;
            ">&times;</span>
            
            <h2 style="
                margin: 0 0 20px 0;
                padding-bottom: 15px;
                border-bottom: 2px solid #3498db;
                color: #2c3e50;
                font-size: 1.8em;
            ">
                <i class="fas fa-users" style="margin-right: 10px; color: #3498db;"></i>
                Club Members
            </h2>
            
            <div id="club-members-container" style="
                margin: 20px 0;
                min-height: 100px;
                position: relative;
            ">
                <div style="
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100px;
                ">
                    <div class="spinner" style="
                        width: 40px;
                        height: 40px;
                        border: 4px solid #f3f3f3;
                        border-top: 4px solid #3498db;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                    "></div>
                </div>
            </div>
            
            <div style="
                margin-top: 30px;
                padding-top: 15px;
                border-top: 1px solid #eee;
                text-align: right;
            ">
                <button onclick="closeClubMembersModal()" style="
                    padding: 10px 20px;
                    background-color: #3498db;
                    color: white;
                    border: none;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 1em;
                    transition: background-color 0.2s ease;
                ">
                    Close
                </button>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        .modal-content th {
            background-color: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
        }
        
        .modal-content td {
            padding: 12px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }
        
        .modal-content tr:hover {
            background-color: #f8f9fa;
        }
    </style>

    <!-- Student Details Modal -->
    <div id="student-details-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="document.getElementById('student-details-modal').style.display='none'">&times;</span>
            <h2>Student Details</h2>
            
            <div class="student-details-grid">
                <div class="detail-group">
                    <h3>Basic Information</h3>
                    <p><strong>Full Name:</strong> <span id="student-details-name"></span></p>
                    <p><strong>Admission #:</strong> <span id="student-details-admission"></span></p>
                    <p><strong>Class:</strong> <span id="student-details-class"></span></p>
                    <p><strong>Gender:</strong> <span id="student-details-gender"></span></p>
                    <p><strong>Date of Birth:</strong> <span id="student-details-dob"></span></p>
                </div>
                
                <div class="detail-group">
                    <h3>Parent/Guardian Information</h3>
                    <p><strong>Name:</strong> <span id="student-details-parent"></span></p>
                    <p><strong>Phone:</strong> <span id="student-details-phone"></span></p>
                    <p><strong>Email:</strong> <span id="student-details-email"></span></p>
                    <p><strong>Address:</strong> <span id="student-details-address"></span></p>
                </div>
                
                <div class="detail-group">
                    <h3>Academic Information</h3>
                    <p><strong>Status:</strong> <span id="student-details-status"></span></p>
                    <p><strong>Admission Date:</strong> <span id="student-details-admission-date"></span></p>
                    <p><strong>Last Updated:</strong> <span id="student-details-updated"></span></p>
                </div>
                
                <div class="detail-group">
                    <h3>Additional Information</h3>
                    <p><strong>Blood Group:</strong> <span id="student-details-blood-group"></span></p>
                    <p><strong>Allergies:</strong> <span id="student-details-allergies"></span></p>
                    <p><strong>Medical Conditions:</strong> <span id="student-details-conditions"></span></p>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-print" onclick="window.print()">
                    <i class="fas fa-print"></i> Print
                </button>
                <button class="btn btn-close" onclick="document.getElementById('student-details-modal').style.display='none'">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Add Student Modal -->
    <div id="add-student-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close">&times;</span>
            <h2>Add New Student</h2>
            <form id="add-student-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">Full Name *</label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="className">Class *</label>
                        <select id="className" name="className" required>
                            <option value="">Select Class</option>
                            <option value="Form 1A">Form 1A</option>
                            <option value="Form 1B">Form 1B</option>
                            <option value="Form 2A">Form 2A</option>
                            <option value="Form 2B">Form 2B</option>
                            <option value="Form 3A">Form 3A</option>
                            <option value="Form 3B">Form 3B</option>
                            <option value="Form 4A">Form 4A</option>
                            <option value="Form 4B">Form 4B</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="gender">Gender *</label>
                        <select id="gender" name="gender" required>
                            <option value="">Select Gender</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateOfBirth">Date of Birth</label>
                        <input type="date" id="dateOfBirth" name="dateOfBirth">
                    </div>
                </div>

                <h3>Parent/Guardian Information</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="parentName">Name *</label>
                        <input type="text" id="parentName" name="parentName" required>
                    </div>
                    <div class="form-group">
                        <label for="parentPhone">Phone *</label>
                        <input type="tel" id="parentPhone" name="parentPhone" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="parentEmail">Email</label>
                        <input type="email" id="parentEmail" name="parentEmail">
                    </div>
                    <div class="form-group">
                        <label for="bloodGroup">Blood Group</label>
                        <select id="bloodGroup" name="bloodGroup">
                            <option value="">Select Blood Group</option>
                            <option value="A+">A+</option>
                            <option value="A-">A-</option>
                            <option value="B+">B+</option>
                            <option value="B-">B-</option>
                            <option value="AB+">AB+</option>
                            <option value="AB-">AB-</option>
                            <option value="O+">O+</option>
                            <option value="O-">O-</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label for="address">Address</label>
                    <textarea id="address" name="address" rows="2"></textarea>
                </div>

                <div class="form-group">
                    <label for="allergies">Allergies</label>
                    <input type="text" id="allergies" name="allergies" placeholder="Enter any known allergies">
                </div>

                <div class="form-group">
                    <label for="medicalConditions">Medical Conditions</label>
                    <input type="text" id="medicalConditions" name="medicalConditions" placeholder="Enter any medical conditions">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('add-student-modal').style.display='none'">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        Save Student
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- User Edit Modal -->
    <div id="user-edit-modal" class="modal">
        <div class="modal-content">
            <button type="button" class="close-modal" id="close-user-edit-modal" aria-label="Close">&times;</button>
            <h2 class="text-2xl font-bold mb-6">Edit User</h2>
            <form id="user-edit-form" class="space-y-4">
                <input type="hidden" id="edit-user-id" />
                
                <div class="form-group">
                    <label for="edit-user-name" class="block text-sm font-medium text-gray-700">Full Name</label>
                    <input type="text" id="edit-user-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required />
                </div>
                
                <div class="form-group">
                    <label for="edit-user-email" class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="edit-user-email" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required />
                </div>
                
                <div class="form-group">
                    <label for="edit-user-username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="edit-user-username" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required />
                </div>
                
                <div class="form-group">
                    <label for="edit-user-role" class="block text-sm font-medium text-gray-700">Role</label>
                    <select id="edit-user-role" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500" required>
                        <option value="">Select a role</option>
                        <option value="Student">Student</option>
                        <option value="Teacher">Teacher</option>
                        <option value="Admin">Administrator</option>
                        <option value="Accountant">Accountant</option>
                        <option value="Parent">Parent</option>
                    </select>
                </div>
                
                <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('edit')">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>
                
                <div id="user-edit-msg" class="mt-4 p-3 rounded hidden"></div>
            </form>
        </div>
    </div>

    <!-- Universal Edit Modal -->
    <div id="universal-edit-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-modal" id="close-universal-edit-modal">&times;</span>
            <h3 id="universal-edit-title">Edit</h3>
            <form id="universal-edit-form"></form>
            <div id="universal-edit-msg" style="display:none;margin-top:8px;"></div>
        </div>
    </div>

    <!-- Universal Confirm Modal -->
    <div id="universal-confirm-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-modal" id="close-universal-confirm-modal">&times;</span>
            <h3 id="universal-confirm-title">Confirm Action</h3>
            <p id="universal-confirm-message">Are you sure you want to proceed?</p>
            <div class="modal-buttons">
                <button id="universal-confirm-yes" class="btn btn-danger">Yes</button>
                <button id="universal-confirm-no" class="btn btn-secondary">No</button>
            </div>
        </div>
    </div>

    <!-- Modal functions -->
    <script>
        // Global variable to store the current user type for registration
        let currentUserType = '';
        
        // Function to populate classes with Kenyan education system data
        async function fetchAndPopulateClasses() {
            const classSelect = document.getElementById('student-class');
            if (!classSelect) {
                console.error('Class select element not found');
                return;
            }
            
            // Create the Kenyan education system structure
            const kenyanEducationSystem = {
                'Pre-Primary': [
                    { id: 'pp1', name: 'Pre-Primary 1 (PP1) - Age 4-5' },
                    { id: 'pp2', name: 'Pre-Primary 2 (PP2) - Age 5-6' }
                ],
                'Primary Education': [
                    { id: 'grade1', name: 'Grade 1 - Age 6-7' },
                    { id: 'grade2', name: 'Grade 2 - Age 7-8' },
                    { id: 'grade3', name: 'Grade 3 - Age 8-9' },
                    { id: 'grade4', name: 'Grade 4 - Age 9-10' },
                    { id: 'grade5', name: 'Grade 5 - Age 10-11' },
                    { id: 'grade6', name: 'Grade 6 - Age 11-12' },
                    { id: 'grade7', name: 'Grade 7 - Age 12-13' },
                    { id: 'grade8', name: 'Grade 8 - Age 13-14 (KCPE)' }
                ],
                'Secondary Education': [
                    { id: 'form1', name: 'Form 1 - Age 14-15' },
                    { id: 'form2', name: 'Form 2 - Age 15-16' },
                    { id: 'form3', name: 'Form 3 - Age 16-17' },
                    { id: 'form4', name: 'Form 4 - Age 17-18 (KCSE)' }
                ],
                'Tertiary/College': [
                    { id: 'college1', name: 'Year 1 - Certificate/Diploma' },
                    { id: 'college2', name: 'Year 2 - Certificate/Diploma' },
                    { id: 'college3', name: 'Year 3 - Diploma/Degree' },
                    { id: 'college4', name: 'Year 4 - Degree' }
                ]
            };

            // Clear existing options
            classSelect.innerHTML = '<option value="">Select Class</option>';
            
            // Add Kenyan education system structure to the dropdown
            for (const [groupName, classes] of Object.entries(kenyanEducationSystem)) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = groupName;
                
                classes.forEach(cls => {
                    const option = document.createElement('option');
                    option.value = cls.id;
                    option.textContent = cls.name;
                    optgroup.appendChild(option);
                });
                
                classSelect.appendChild(optgroup);
            }
            
            console.log('Successfully populated classes dropdown with Kenyan education system');
        }
        
        function openRegistrationModal(userType) {
            try {
                console.log('Opening registration modal for:', userType);
                
                const modal = document.getElementById('registrationModal');
                const modalTitle = document.getElementById('modal-title');
                const teacherFields = document.getElementById('teacher-fields');
                const classSelection = document.getElementById('class-selection');
                const registrationForm = document.getElementById('registration-form');
                
                // Debug log elements
                console.log('Modal element:', modal);
                console.log('Modal title:', modalTitle);
                console.log('Teacher fields:', teacherFields);
                console.log('Class selection:', classSelection);
                console.log('Registration form:', registrationForm);
                
                if (!modal || !modalTitle || !teacherFields || !classSelection || !registrationForm) {
                    throw new Error('One or more required elements not found');
                }
                
                // Ensure modal is in the document flow and visible
                modal.style.display = 'block';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.overflow = 'auto';
                
                // Ensure modal content is properly positioned
                const content = modal.querySelector('.modal-content');
                if (content) {
                    content.style.margin = '50px auto';
                    content.style.position = 'relative';
                }
                
                // Store current user type
                currentUserType = userType;
                
                // Reset form
                registrationForm.reset();
                
                // Update modal title based on user type
                const title = userType === 'teacher' ? 'Teacher Registration' : 'Student Registration';
                modalTitle.textContent = title;
                
                // Show/hide fields based on user type
                const studentClassSelect = document.getElementById('student-class');
                if (userType === 'teacher') {
                    teacherFields.style.display = 'block';
                    classSelection.style.display = 'none';
                    // Remove required attribute for teacher registration
                    if (studentClassSelect) {
                        studentClassSelect.removeAttribute('required');
                    }
                } else {
                    teacherFields.style.display = 'none';
                    classSelection.style.display = 'block';
                    // Add required attribute for student registration
                    if (studentClassSelect) {
                        studentClassSelect.setAttribute('required', 'required');
                    }
                    // Fetch and populate classes for students
                    fetchAndPopulateClasses();
                }
                
                // Force reflow/repaint to ensure styles are applied
                void modal.offsetHeight;
                
                // Add show class with a small delay to allow for transition
                setTimeout(() => {
                    modal.classList.add('show');
                    document.body.style.overflow = 'hidden'; // Prevent scrolling when modal is open
                    
                    // Force focus to the modal for better accessibility
                    modal.setAttribute('aria-hidden', 'false');
                    modal.focus();
                    
                    console.log('Modal should be visible now');
                }, 50);
                
            } catch (error) {
                console.error('Error in openRegistrationModal:', error);
                alert('Error opening registration form: ' + error.message);
            }
        }

        function closeRegistrationModal() {
            const modal = document.getElementById('registrationModal');
            if (!modal) return;
            
            // Remove show class to trigger fade out
            modal.classList.remove('show');
            document.body.style.overflow = ''; // Re-enable scrolling
            
            // Wait for the transition to complete before hiding completely
            setTimeout(() => {
                if (modal) {
                    modal.style.display = 'none';
                }
            }, 300);
        }

        // Validate password match
        function validatePasswords() {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorElement = document.getElementById('password-match-error');
            
            if (password !== confirmPassword) {
                errorElement.style.display = 'block';
                return false;
            }
            errorElement.style.display = 'none';
            return true;
        }
        
        // Add password visibility toggle functionality
        function setupPasswordToggles() {
            document.querySelectorAll('.toggle-password').forEach(button => {
                button.addEventListener('click', function() {
                    const input = this.previousElementSibling;
                    const icon = this.querySelector('i');
                    
                    // Toggle input type
                    const type = input.type === 'password' ? 'text' : 'password';
                    input.type = type;
                    
                    // Toggle icon
                    icon.classList.toggle('fa-eye');
                    icon.classList.toggle('fa-eye-slash');
                    
                    // Update button's aria-label
                    const action = type === 'password' ? 'Show' : 'Hide';
                    this.setAttribute('aria-label', `${action} password`);
                });
            });
        }
        
        // Add password validation on input
        document.addEventListener('DOMContentLoaded', () => {
            // Setup password validation
            const passwordFields = document.querySelectorAll('#password, #confirm-password');
            passwordFields.forEach(field => {
                field.addEventListener('input', validatePasswords);
            });
            
            // Setup password toggles
            setupPasswordToggles();
        });
        
        // Handle registration form submission
        async function handleRegistrationSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const formData = new FormData(form);
            const submitButton = form.querySelector('button[type="submit"]');
            const submitButtonText = submitButton.textContent;
            
            try {
                // Get form data
                const password = formData.get('password');
                const confirmPassword = formData.get('confirmPassword');
                const name = formData.get('name');
                const email = formData.get('email');
                
                // Basic validation
                if (!name || !email || !password || !confirmPassword) {
                    throw new Error('All fields are required');
                }
                
                // Validate email format
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                    throw new Error('Please enter a valid email address');
                }
                
                // Validate password length
                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters long');
                }
                
                // Validate passwords match
                if (password !== confirmPassword) {
                    throw new Error('Passwords do not match');
                }
                
                // Disable submit button and show loading state
                submitButton.disabled = true;
                submitButton.textContent = 'Processing...';
                
                // Get the class value first (for students)
                let studentClass = '';
                let displayClass = '';
                if (currentUserType === 'student') {
                    const classSelect = document.getElementById('student-class');
                    studentClass = classSelect ? classSelect.value : '';
                    
                    console.log('Form data - studentClass:', studentClass, 'from select element');
                    
                    if (!studentClass) {
                        throw new Error('Please select a class for the student');
                    }
                    
                    // Get the display text of the selected option
                    if (classSelect) {
                        const selectedOption = classSelect.options[classSelect.selectedIndex];
                        displayClass = selectedOption.text.split(' - ')[0].trim();
                        console.log('Formatted class:', displayClass);
                    }
                }
                
                // Prepare user data in the format expected by the backend
                const userData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    role: currentUserType,
                    // Set class at root level for students using the display value
                    ...(currentUserType === 'student' && { class: displayClass || studentClass }),
                    // Include all other fields in the profile object
                    profile: {
                        dob: formData.get('dob'),
                        gender: formData.get('gender'),
                        phone: formData.get('phone'),
                        address: formData.get('address'),
                        bloodGroup: formData.get('blood-group'),
                        emergencyContact: {
                            name: formData.get('emergencyContactName'),
                            phone: formData.get('emergencyContactPhone'),
                            relationship: formData.get('emergencyContactRelationship')
                        },
                        specialization: formData.get('specialization') || undefined,
                        // Set class in profile as well using the display value
                        ...(currentUserType === 'student' && { class: displayClass || studentClass })
                    }
                };
                
                console.log('User data being sent to backend:', JSON.stringify({
                    ...userData,
                    password: '***' // Don't log the actual password
                }, null, 2));
                
                const response = await fetch('http://localhost:5000/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(userData)
                });
                
                const data = await response.json();
                console.log('Registration response:', data);
                
                if (!response.ok) {
                    // Handle validation errors
                    if (data.errors && Array.isArray(data.errors)) {
                        const errorMessages = data.errors.map(err => err.msg || err.message).join('\n');
                        throw new Error(errorMessages || 'Validation failed');
                    }
                    throw new Error(data.message || 'Registration failed');
                }
                
                // Show success message
                alert(`${currentUserType === 'teacher' ? 'Teacher' : 'Student'} registered successfully!`);
                
                // Close modal
                closeRegistrationModal();
                
                // Refresh the appropriate list
                if (currentUserType === 'teacher') {
                    loadTeachers();
                } else {
                    loadStudents();
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert(`Error: ${error.message || 'Failed to register. Please try again.'}`);
            } finally {
                // Re-enable submit button
                submitButton.disabled = false;
                submitButton.textContent = submitButtonText;
            }
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            var modal = document.getElementById('registrationModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>

    <!-- Add the registration form submit event listener -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const registrationForm = document.getElementById('registration-form');
            if (registrationForm) {
                registrationForm.addEventListener('submit', handleRegistrationSubmit);
            }
        });
    </script>
    
    <!-- Student Management JS -->
    <script src="../js/student-management.new.js"></script>
    <script>
        // Sidebar Toggle Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.querySelector('.sidebar');
            const sidebarToggle = document.querySelector('.sidebar-toggle');
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabSections = document.querySelectorAll('.tab-section');
            
            // Toggle sidebar on mobile
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('active');
                    document.body.classList.toggle('sidebar-active');
                });
            }
            
            // Tab switching functionality
            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetTab = this.getAttribute('data-tab');
                    
                    // Update active tab
                    tabLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show target section
                    tabSections.forEach(section => {
                        section.style.display = 'none';
                    });
                    
                    const targetSection = document.getElementById(targetTab);
                    if (targetSection) {
                        targetSection.style.display = 'block';
                    }
                });
            });
            
            // Initialize first tab as active
            if (tabLinks.length > 0) {
                const firstTab = document.querySelector('.tab-link.active') || tabLinks[0];
                firstTab.click();
            }
            
            // Close sidebar when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth < 1024 && !sidebar.contains(e.target) && e.target !== sidebarToggle) {
                    sidebar.classList.remove('active');
                    document.body.classList.remove('sidebar-active');
                }
            });
            
            // Initialize charts if needed
            initializeCharts();
        });
        
        // Initialize sample charts
        function initializeCharts() {
            // Sample chart initialization - you can customize this based on your needs
            const ctx = document.getElementById('attendanceChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Attendance Rate',
                            data: [85, 88, 92, 90, 94, 95],
                            borderColor: 'rgba(79, 70, 229, 1)',
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            tension: 0.3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false,
                                min: 80,
                                max: 100
                            }
                        }
                    }
                });
            }
        }
        
        // Sample function to show notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            container.appendChild(notification);
            
            // Auto-remove notification after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
    </script>
    
    <style>
        /* Utility Classes */
        .mb-8 {
            margin-bottom: 2rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Card Styles */
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .card-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        /* Gradient Backgrounds */
        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
        }

        .from-indigo-50 { --tw-gradient-from: #eef2ff; }
        .to-indigo-100 { --tw-gradient-to: #e0e7ff; }
        .from-blue-50 { --tw-gradient-from: #eff6ff; }
        .to-blue-100 { --tw-gradient-to: #dbeafe; }
        .from-purple-50 { --tw-gradient-from: #f5f3ff; }
        .to-purple-100 { --tw-gradient-to: #ede9fe; }

        /* Text Colors */
        .text-indigo-600 { color: #4f46e5; }
        .text-blue-600 { color: #2563eb; }
        .text-purple-600 { color: #7c3aed; }
        .text-green-600 { color: #059669; }
        .text-gray-900 { color: #111827; }
        .text-gray-500 { color: #6b7280; }
        .text-gray-400 { color: #9ca3af; }

        /* Background Colors */
        .bg-indigo-100 { background-color: #e0e7ff; }
        .bg-blue-100 { background-color: #dbeafe; }
        .bg-purple-100 { background-color: #ede9fe; }
        .bg-green-100 { background-color: #d1fae5; }

        /* Notification Styles */
        .notification-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 9999;
            max-width: 350px;
        }
        
        .notification {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin-bottom: 0.75rem;
            position: relative;
            overflow: hidden;
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease;
            border-left: 4px solid #4f46e5;
        }
        
        .notification.success {
            border-left-color: #10b981;
        }
        
        .notification.error {
            border-left-color: #ef4444;
        }
        
        .notification.warning {
            border-left-color: #f59e0b;
        }
        
        .notification.fade-out {
            transform: translateX(100%);
            opacity: 0;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
                padding-top: 4rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="../js/dashboard.js"></script>
    <script>
        // Tab switching
        function showTab(tabId) {
            // Hide all tab sections
            document.querySelectorAll('.tab-section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the selected tab section
            const tabSection = document.getElementById(tabId + '-section');
            if (tabSection) {
                tabSection.style.display = 'block';
                
                // Initialize accountant fees when the accountant tab is shown
                if (tabId === 'accountant' && typeof AccountantFees === 'function' && !window.accountantFeesInitialized) {
                    try {
                        window.accountantFees = new AccountantFees();
                        window.accountantFeesInitialized = true;
                        console.log('AccountantFees initialized');
                    } catch (error) {
                        console.error('Error initializing AccountantFees:', error);
                    }
                }
            }
        }

        // Load data when registration section is shown
        document.addEventListener('DOMContentLoaded', () => {
            const registrationSection = document.getElementById('registration-section');
            if (registrationSection) {
                loadStudents();
                loadTeachers();
            }
        });

        // Load students data
        async function loadStudents() {
            const studentsList = document.getElementById('students-list');
            if (!studentsList) return;

            try {
                const response = await fetch('http://localhost:5000/api/students');
                const data = await response.json();
                
                if (!data || !Array.isArray(data.students)) {
                    studentsList.innerHTML = '<p>No students found</p>';
                    return;
                }

                const students = data.students;
                
                // Create HTML for students
                let html = students.map(student => {
                    // Get class from various possible locations in the student object
                    const studentClass = student.class || student.classAssigned || (student.profile && student.profile.class) || 'Not assigned';
                    
                    return `
                    <div class="student-item">
                        <h4>${student.name}</h4>
                        <p>Email: ${student.email}</p>
                        <p>Class: ${studentClass}</p>
                        <div class="action-buttons">
                            <button onclick="editStudent('${student._id}')">Edit</button>
                            <button onclick="deleteStudent('${student._id}')">Delete</button>
                        </div>
                    </div>
                    `;
                }).join('');

                studentsList.innerHTML = html;
            } catch (error) {
                console.error('Error loading students:', error);
                studentsList.innerHTML = '<p>Error loading students data</p>';
            }
        }

        // Load teachers data
        async function loadTeachers() {
            const teachersList = document.getElementById('teachers-list');
            if (!teachersList) {
                console.error('Teachers list element not found');
                return;
            }

            try {
                const response = await fetch('http://localhost:5000/api/students/teachers');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                // Handle both array and object responses
                const teachers = Array.isArray(data) ? data : (data.teachers || []);
                
                if (Array.isArray(teachers) && teachers.length > 0) {
                    teachersList.innerHTML = teachers.map(teacher => `
                        <div class="teacher-item">
                            <h3>${teacher.name || 'No Name'}</h3>
                            <p>Email: ${teacher.email || 'No Email'}</p>
                            <div class="action-buttons">
                                <button onclick="editTeacher('${teacher._id || teacher.id || ''}')">Edit</button>
                                <button onclick="deleteTeacher('${teacher._id || teacher.id || ''}')">Delete</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    console.log('No teachers data available');
                    teachersList.innerHTML = '<p>No teachers found</p>';
                }
            } catch (error) {
                console.error('Error loading teachers:', error);
                teachersList.innerHTML = '<p>Error loading teachers data</p>';
            }
        }

        // Edit functions (to be implemented)
        function editStudent(studentId) {
            console.log('Edit student:', studentId);
        }

        function editTeacher(teacherId) {
            console.log('Edit teacher:', teacherId);
        }

        // Delete functions (to be implemented)
        function deleteStudent(studentId) {
            if (confirm('Are you sure you want to delete this student?')) {
                fetch(`http://localhost:5000/api/students/${studentId}`, {
                    method: 'DELETE'
                })
                .then(() => loadStudents())
                .catch(error => console.error('Error deleting student:', error));
            }
        }

        function deleteTeacher(teacherId) {
            if (confirm('Are you sure you want to delete this teacher?')) {
                fetch(`http://localhost:5000/api/students/${teacherId}`, {
                    method: 'DELETE'
                })
                .then(() => loadTeachers())
                .catch(error => console.error('Error deleting teacher:', error));
            }
        }
    </script>
    <script>
        // Load profile data
        async function loadProfile() {
            try {
                const response = await fetch('http://localhost:5000/api/students/profile');
                const profileData = await response.json();
                
                if (profileData && profileData.name) {
                    const profileInfo = document.getElementById('profile-info');
                    profileInfo.innerHTML = `
                        <div class="profile-details">
                            <p><strong>Name:</strong> ${profileData.name}</p>
                            <p><strong>Email:</strong> ${profileData.email}</p>
                            <p><strong>Role:</strong> ${profileData.role}</p>
                            ${profileData.class ? `<p><strong>Class:</strong> ${profileData.class}</p>` : ''}
                            <p><strong>Phone:</strong> ${profileData.phone || 'Not provided'}</p>
                        </div>
                    `;
                } else {
                    console.error('Invalid profile data:', profileData);
                    document.getElementById('profile-info').innerHTML = '<p>Error loading profile</p>';
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                document.getElementById('profile-info').innerHTML = '<p>Error loading profile</p>';
            }
        }

        // Toggle password change form visibility
        document.getElementById('toggle-password-btn').addEventListener('click', function() {
            const changePasswordSection = document.querySelector('.change-password-section');
            changePasswordSection.style.display = changePasswordSection.style.display === 'none' ? 'block' : 'none';
        });

    // Validate passwords match
    if (password !== confirmPassword) {
        alert('Passwords do not match!');
        return;
    }

    try {
        const response = await fetch('http://localhost:5000/api/students/change-password', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
                currentPassword,
                newPassword: password
            })
        });

        const data = await response.json();

        if (response.ok) {
            alert('Password changed successfully');
            document.getElementById('change-password-form').reset();
            document.querySelector('.change-password-section').style.display = 'none';
        } else {
            alert(data.error || 'Failed to change password');
        }
    } catch (error) {
        console.error('Error changing password:', error);
        alert('An error occurred while changing password');
    }

        // Function to load today's attendance - now in global scope
        window.loadTodaysAttendance = async function() {
            console.log('Loading today\'s attendance data...');
            try {
                // Get today's date in YYYY-MM-DD format
                const today = new Date().toISOString().split('T')[0];
                console.log('Fetching attendance for date:', today);
                
                // Fetch attendance data for today
                const response = await fetch(`http://localhost:5000/api/attendance/history?start=${today}&end=${today}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Failed to fetch attendance data: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Raw attendance data received:', data);
                
                // Calculate present and absent counts
                let presentCount = 0;
                let absentCount = 0;
                
                if (Array.isArray(data)) {
                    console.log(`Processing ${data.length} attendance records`);
                    
                    data.forEach((record, index) => {
                        console.log(`Record ${index + 1}:`, record);
                        
                        if (record && typeof record === 'object' && record.records && Array.isArray(record.records)) {
                            console.log(`  Found ${record.records.length} student records`);
                            
                            record.records.forEach((student, studentIndex) => {
                                console.log(`    Student ${studentIndex + 1}:`, student);
                                
                                if (student && typeof student === 'object' && student.status) {
                                    if (student.status === 'present' || student.status === 'late') {
                                        presentCount++;
                                        console.log(`    ✅ Marked as present`);
                                    } else if (student.status === 'absent') {
                                        absentCount++;
                                        console.log(`    ❌ Marked as absent`);
                                    } else {
                                        console.log(`    ⚠️ Unknown status: ${student.status}`);
                                    }
                                } else {
                                    console.log('    ⚠️ Invalid student record format:', student);
                                }
                            });
                        } else {
                            console.log('  ⚠️ Record is missing records array or invalid format:', record);
                        }
                    });
                    
                    if (data.length === 0) {
                        console.log('No attendance records found for today');
                    }
                } else {
                    console.warn('Expected array data but received:', typeof data, data);
                }
                
                console.log('Present count:', presentCount, 'Absent count:', absentCount);
                
                // Update the UI
                const presentElement = document.getElementById('today-present');
                const absentElement = document.getElementById('today-absent');
                
                if (presentElement) {
                    presentElement.textContent = presentCount;
                } else {
                    console.error('Element with ID "today-present" not found');
                }
                
                if (absentElement) {
                    absentElement.textContent = absentCount;
                } else {
                    console.error('Element with ID "today-absent" not found');
                }
                
                // Update the date display
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const todayFormatted = new Date().toLocaleDateString(undefined, options);
                const dateElement = document.getElementById('attendance-date');
                
                if (dateElement) {
                    dateElement.textContent = `As of ${todayFormatted}`;
                } else {
                    console.error('Element with ID "attendance-date" not found');
                }
                
            } catch (error) {
                console.error('Error loading attendance data:', error);
                const dateElement = document.getElementById('attendance-date');
                if (dateElement) {
                    dateElement.textContent = 'Error loading attendance data';
                }
            }
        };
        
        // Load profile data when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded');
            loadProfile();
            console.log('Profile loaded, now loading attendance...');
            try {
                loadTodaysAttendance(); // Load today's attendance data
            } catch (error) {
                console.error('Error in loadTodaysAttendance:', error);
                const dateElement = document.getElementById('attendance-date');
                if (dateElement) {
                    dateElement.textContent = 'Error loading attendance';
                }
            }
            console.log('Attendance load attempt completed');
        });
        
        // Also try to run it after a short delay in case the DOMContentLoaded event is missed
        setTimeout(() => {
            console.log('Running delayed attendance check...');
            if (document.readyState === 'complete') {
                try {
                    loadTodaysAttendance();
                } catch (error) {
                    console.error('Error in delayed loadTodaysAttendance:', error);
                }
            }
        }, 1000);
        
        // Test function that can be called from console
        window.testAttendance = async function() {
            console.log('=== Testing Attendance Loading ===');
            console.log('1. Checking if function exists:', typeof loadTodaysAttendance === 'function');
            console.log('2. Checking if elements exist:', {
                'today-present': document.getElementById('today-present') ? 'Found' : 'Not found',
                'today-absent': document.getElementById('today-absent') ? 'Found' : 'Not found',
                'attendance-date': document.getElementById('attendance-date') ? 'Found' : 'Not found'
            });
            
            // Test direct API call
            console.log('3. Testing API endpoint...');
            try {
                const today = new Date().toISOString().split('T')[0];
                const token = localStorage.getItem('token');
                console.log('   - Using token:', token ? 'Found' : 'Not found');
                console.log('   - Testing endpoint: /api/attendance/history');
                
                const response = await fetch(`http://localhost:5000/api/attendance/history?start=${today}&end=${today}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('   - Response status:', response.status);
                const data = await response.json().catch(e => {
                    console.error('   - Error parsing JSON:', e);
                    return { error: 'Invalid JSON response' };
                });
                
                console.log('   - Response data:', data);
                console.log('4. API test completed');
                
                // If API works, try the function
                console.log('5. Testing function call...');
                try {
                    loadTodaysAttendance();
                    console.log('6. Function called successfully');
                } catch (e) {
                    console.error('6. Error calling function:', e);
                }
                
            } catch (error) {
                console.error('   - API test failed:', error);
            }
        };

        // Move loadTodaysAttendance to global scope
        window.loadTodaysAttendance = loadTodaysAttendance;
        console.log('loadTodaysAttendance function defined in global scope');

        // Test function with sample data
        const testWithSampleData = async function() {
            console.log('=== Testing with Sample Data ===');
            
            // Sample data that matches the expected format
            const sampleData = [
                {
                    date: new Date().toISOString().split('T')[0],
                    records: [
                        { studentId: '1', status: 'present' },
                        { studentId: '2', status: 'present' },
                        { studentId: '3', status: 'absent' },
                        { studentId: '4', status: 'present' },
                        { studentId: '5', status: 'absent' }
                    ]
                }
            ];
            
            // Save original fetch
            const originalFetch = window.fetch;
            
            // Mock the fetch function
            window.fetch = function() {
                console.log('Mock fetch called with sample data');
                return Promise.resolve({
                    ok: true,
                    json: function() {
                        return Promise.resolve(sampleData);
                    }
                });
            };
            
            try {
                // Call the function with mock data
                console.log('Calling loadTodaysAttendance with sample data...');
                await loadTodaysAttendance();
                console.log('Sample data test completed');
                
                // Manually update the UI to show test data
                document.getElementById('today-present').textContent = '3';
                document.getElementById('today-absent').textContent = '2';
                document.getElementById('attendance-date').textContent = 'As of ' + new Date().toLocaleDateString();
                
            } catch (error) {
                console.error('Error in sample data test:', error);
            } finally {
                // Restore original fetch
                window.fetch = originalFetch;
            }
        };
        
        // Handle form submission

        // Handle form submission
        document.getElementById('registration-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const userType = document.getElementById('modal-title').textContent.includes('Teacher') ? 'teacher' : 'student';
            const formData = new FormData(this);
            
            // Add user type to form data
            formData.append('userType', userType);
            
            try {
                // Convert FormData to object
                const userData = Object.fromEntries(formData);
                
                // Validate required fields
                if (!userData.name || !userData.email || !userData.phone) {
                    throw new Error('Please fill in all required fields: name, email, and phone');
                }

                // Log the data being sent
                console.log('Sending registration data:', userData);

                // Use the correct registration endpoint
                const response = await fetch('http://localhost:5000/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(userData)
                });

                const result = await response.json();
                
                if (response.status === 200) {
                  // Load all dashboard data
    async function loadDashboardData() {
        try {
            await Promise.all([
                loadStudentsCount(),
                loadTeachersCount(),
                loadBooksCount(),
                loadClubsCount(),
                loadTotalFees(),
                loadTodayAttendance()
            ]);
            console.log('Dashboard data loaded successfully');
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }    alert('Registration failed: ' + error.message);
            }
        });

        // Update fields based on role selection
        function updateFields() {
            const roleSelect = document.getElementById('role-select');
            const teacherFields = document.getElementById('teacher-fields');
            
            if (roleSelect && teacherFields) {
                teacherFields.style.display = roleSelect.value === 'teacher' ? 'block' : 'none';
            }
        }

        // Add event listener for role selection
        const roleSelect = document.getElementById('role-select');
        if (roleSelect) {
            roleSelect.addEventListener('change', updateFields);
            updateFields();
        }
    </script>
    <script src="/js/admin.js"></script>
    <script src="/js/clubs.js"></script>
    <script src="/js/library.js"></script>
    <script src="/js/accountant-new.js?v=1.0.1"></script>
    <script src="/js/events.js"></script>
    <script src="/js/backup.js"></script>
    <script src="/js/roles.js"></script>
    <script src="../js/script.js"></script>
    <script src="../js/accountant-fees.js"></script>
    
    <!-- Test script to verify loading -->
    <script>
        console.log('Test script running');
        
        // Wait for the page to fully load
        window.addEventListener('load', function() {
            console.log('Page fully loaded');
            
            // Check if our script is loaded
            if (window.initializeAccountantPage) {
                console.log('Accountant script is loaded');
            } else {
                console.error('Accountant script is NOT loaded');
            }
            
            // Check if the class select element exists
            const classSelect = document.getElementById('fee-class-name');
            if (classSelect) {
                console.log('Class select element found:', classSelect);
                
                // Try to load classes directly
                console.log('Attempting to load classes...');
                loadClasses();
            } else {
                console.error('Class select element NOT found');
            }
        });
    </script>
    <script src="/js/dashboard-analytics.js"></script>
    <script>
        // Broadcast Communication Functionality
        document.getElementById('broadcast-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const target = document.getElementById('broadcast-target').value;
            const title = document.getElementById('broadcast-title').value;
            const message = document.getElementById('broadcast-message').value;
            const logList = document.getElementById('broadcast-log-list');
            const li = document.createElement('li');
            li.innerHTML = `<strong>${title}</strong> [${target}] - ${message}`;
            logList.appendChild(li);
            alert("Broadcast sent successfully!");
            this.reset();
        });

        // Entities Management Functionality
        document.getElementById('add-class-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const className = document.getElementById('class-name').value;
            const classTeacher = document.getElementById('class-teacher').value;
            const li = document.createElement('li');
            li.innerHTML = `<strong>${className}</strong> - Assigned Teacher: ${classTeacher}`;
            document.getElementById('class-list').appendChild(li);
            alert("Class added successfully!");
            this.reset();
        });

        document.getElementById('add-subject-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const subjectName = document.getElementById('subject-name').value;
            const subjectCode = document.getElementById('subject-code').value;
            const li = document.createElement('li');
            li.innerHTML = `<strong>${subjectName}</strong> (Code: ${subjectCode})`;
            document.getElementById('subject-list').appendChild(li);
            alert("Subject added successfully!");
            this.reset();
        });

        // Show/hide extra fields based on role
        document.addEventListener('DOMContentLoaded', function() {
            const roleSelect = document.getElementById('user-role');
            const subjectInput = document.getElementById('user-subject');
            const classInput = document.getElementById('user-class');
            function updateFields() {
                const role = roleSelect.value;
                subjectInput.style.display = (role === 'Teacher') ? '' : 'none';
                classInput.style.display = (role === 'Student') ? '' : 'none';
            }
            roleSelect.addEventListener('change', updateFields);
            updateFields();
        });
    </script>
    
    <!-- Return Book Modal -->
    <div class="modal fade" id="returnBookModal" tabindex="-1" aria-labelledby="returnBookModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="returnBookModalLabel">Return Book</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="returnBookForm">
                    <div class="modal-body">
                        <p>You are about to return the following book:</p>
                        <p><strong>Title:</strong> <span class="book-title"></span></p>
                        <p><strong>Borrower:</strong> <span class="borrower-name"></span></p>
                        
                        <div class="fine-section">
                            <div class="mb-3">
                                <label for="finePaid" class="form-label">Fine Amount: <span class="fine-amount">KES 0.00</span></label>
                                <input type="number" class="form-control" id="finePaid" name="finePaid" min="0" step="0.01" value="0.00">
                                <div class="form-text">Enter the amount paid (if any).</div>
                            </div>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmReturn" required>
                            <label class="form-check-label" for="confirmReturn">
                                I confirm that the book has been returned in good condition.
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-check me-1"></i> Confirm Return
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Library Management Script -->
    <script>
        // Set API configuration before loading the library module
        window.API_CONFIG = { BASE_URL: 'http://localhost:5000' };
    </script>
    
    <!-- jQuery (required for Bootstrap modals) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Library Module -->
    <script type="module" src="/js/library.js"></script>
    
    <!-- Admin Attendance Management -->
    <script src="/js/admin-attendance.js"></script>
    
    <!-- Global Attendance Function -->
    <script>
    // Define the function in the global scope
    window.loadTodaysAttendance = async function() {
        console.log('Global loadTodaysAttendance function called');
        try {
            // Get date range (today and past 6 days)
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 6); // 6 days ago + today = 7 days total
            
            const formatDate = (date) => date.toISOString().split('T')[0];
            const todayStr = formatDate(today);
            const sevenDaysAgoStr = formatDate(sevenDaysAgo);
            
            console.log(`Fetching attendance from ${sevenDaysAgoStr} to ${todayStr}`);
            
            // Get user data from localStorage
            const userData = JSON.parse(localStorage.getItem('userData')) || {};
            console.log('User role:', userData.role);
            
            // If not admin, try to get the user's class
            if (userData.role !== 'admin') {
                let userClass = '';
                const possibleClassPaths = [
                    userData.class,
                    userData.profile?.class,
                    userData.user?.class,
                    userData.user?.profile?.class
                ];
                
                // Find the first non-empty class value
                userClass = possibleClassPaths.find(c => c) || '';
                
                if (!userClass) {
                    console.error('User class not found in user data');
                    document.getElementById('attendance-date').textContent = 'Error: Class not found for your account';
                    return;
                }
                
                console.log('Using class for attendance:', userClass);
                const url = `http://localhost:5000/api/attendance/history?class=${encodeURIComponent(userClass)}&start=${sevenDaysAgoStr}&end=${todayStr}`;
                await fetchAndDisplayAttendance(url);
            } else {
                console.log('Admin user - fetching all classes first');
                // First, get the list of all classes
                const classesResponse = await fetch('http://localhost:5000/api/classes', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                if (!classesResponse.ok) {
                    throw new Error(`Failed to fetch classes: ${classesResponse.status} ${classesResponse.statusText}`);
                }
                
                const classes = await classesResponse.json();
                console.log('Available classes:', classes);
                
                if (!Array.isArray(classes) || classes.length === 0) {
                    throw new Error('No classes found');
                }
                
                // Fetch attendance for each class and combine results
                let allAttendance = [];
                // Add standard grade classes if not present
                const standardClasses = ['Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8'];
                
                // Combine existing classes with standard grade classes
                const allClasses = [...new Set([
                    ...classes.map(c => c.name || c._id),
                    ...standardClasses
                ])];
                
                for (const className of allClasses) {
                    console.log(`Fetching attendance for class: ${className}`);
                    
                    try {
                        // Try with the exact class name first
                        let classResponse = await fetch(`http://localhost:5000/api/attendance/history?class=${encodeURIComponent(className)}&start=${sevenDaysAgoStr}&end=${todayStr}`, {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            }
                        });
                        
                        if (classResponse.ok) {
                            const classData = await classResponse.json();
                            console.log(`Attendance for ${className}:`, classData);
                            if (Array.isArray(classData)) {
                                allAttendance = allAttendance.concat(classData);
                            }
                        } else {
                            console.error(`Failed to fetch attendance for class ${className}:`, classResponse.status);
                        }
                    } catch (error) {
                        console.error(`Error fetching attendance for class ${className}:`, error);
                    }
                }
                
                console.log('All attendance data:', allAttendance);
                
                // If no attendance found, try with a wider date range (last 30 days)
                if (allAttendance.length === 0) {
                    console.log('No recent attendance found. Trying a wider date range (last 30 days)...');
                    const thirtyDaysAgo = new Date();
                    thirtyDaysAgo.setDate(today.getDate() - 30);
                    const thirtyDaysAgoStr = formatDate(thirtyDaysAgo);
                    
                    for (const className of allClasses) {
                        try {
                            const response = await fetch(`http://localhost:5000/api/attendance/history?class=${encodeURIComponent(className)}&start=${thirtyDaysAgoStr}&end=${todayStr}`, {
                                headers: {
                                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                                }
                            });
                            
                            if (response.ok) {
                                const data = await response.json();
                                if (Array.isArray(data) && data.length > 0) {
                                    allAttendance = allAttendance.concat(data);
                                    console.log(`Found ${data.length} attendance records for ${className}`);
                                }
                            }
                        } catch (error) {
                            console.error(`Error fetching attendance for ${className}:`, error);
                        }
                    }
                }
                
                if (allAttendance.length > 0) {
                    console.log(`Found a total of ${allAttendance.length} attendance records`);
                    processAttendanceData(allAttendance, true);
                } else {
                    console.log('No attendance records found in the past 30 days');
                    document.getElementById('today-present').textContent = '0';
                    document.getElementById('today-absent').textContent = '0';
                    document.getElementById('attendance-date').textContent = 'No attendance records found';
                }
                return;
            }
            
            // Fetch and process attendance data from a URL
            async function fetchAndDisplayAttendance(url) {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Failed to fetch attendance data: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Raw attendance data received:', data);
                
                processAttendanceData(data);
            }
            
            // Process attendance data and update UI
            function processAttendanceData(data, isAdminView = false) {
                if (!Array.isArray(data)) {
                    console.warn('Expected array data but received:', typeof data, data);
                    data = [];
                }

                // Calculate present and absent counts
                let presentCount = 0;
                let absentCount = 0;
                
                console.log(`Processing ${data.length} attendance records`);
                
                // Get today's date in YYYY-MM-DD format for comparison
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                data.forEach((record, index) => {
                    console.log(`Record ${index + 1}:`, record);
                    
                    // Skip records that aren't from today
                    const recordDate = record.date ? new Date(record.date).toISOString().split('T')[0] : null;
                    if (recordDate !== todayStr) {
                        console.log(`  ⏩ Skipping record from ${recordDate} (not today)`);
                        return;
                    }
                    
                    if (record && typeof record === 'object' && record.records && Array.isArray(record.records)) {
                        console.log(`  Found ${record.records.length} student records`);
                        
                        record.records.forEach((student, studentIndex) => {
                            console.log(`    Student ${studentIndex + 1}:`, student);
                            
                            if (student && typeof student === 'object' && student.status) {
                                if (student.status === 'present' || student.status === 'late') {
                                    presentCount++;
                                    console.log(`    ✅ Marked as present`);
                                } else if (student.status === 'absent') {
                                    absentCount++;
                                    console.log(`    ❌ Marked as absent`);
                                } else {
                                    console.log(`    ⚠️ Unknown status: ${student.status}`);
                                }
                            } else {
                                console.log('    ⚠️ Invalid student record format:', student);
                            }
                        });
                    } else {
                        console.log('  ⚠️ Record is missing records array or invalid format:', record);
                    }
                });
                
                if (data.length === 0) {
                    console.log('No attendance records found for today');
                }
            
                console.log('Present count:', presentCount, 'Absent count:', absentCount);
                
                // Update the UI
                const presentElement = document.getElementById('today-present');
                const absentElement = document.getElementById('today-absent');
                
                if (presentElement) {
                    presentElement.textContent = presentCount;
                } else {
                    console.error('Element with ID "today-present" not found');
                }
                
                if (absentElement) {
                    absentElement.textContent = absentCount;
                } else {
                    console.error('Element with ID "today-absent" not found');
                }
                
                // Update the date display to show only today's date
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const todayFormatted = new Date().toLocaleDateString(undefined, options);
                const dateElement = document.getElementById('attendance-date');
                
                if (dateElement) {
                    dateElement.textContent = `Today • ${todayFormatted}`;
                } else {
                    console.error('Element with ID "attendance-date" not found');
                }
            }
            
        } catch (error) {
            console.error('Error in global loadTodaysAttendance:', error);
            const dateElement = document.getElementById('attendance-date');
            if (dateElement) {
                dateElement.textContent = 'Error loading attendance';
            }
        }
    };
    
    // Log that the function is available
    console.log('Global loadTodaysAttendance function is now available');
    
    // Function to load and update total fees on dashboard
    async function loadTotalFees() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                return;
            }
            
            console.log('Fetching fees from API...');
            // Fetch all fees with student population to get expected fees
            const [feesResponse, paymentsResponse] = await Promise.all([
                fetch('http://localhost:5000/api/fees?populate=student', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }),
                // Fetch payments data to calculate actual fees paid
                fetch('http://localhost:5000/api/payments?status=completed', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                })
            ]);
            
            if (!feesResponse.ok || !paymentsResponse.ok) {
                const feesError = await feesResponse.text().catch(() => '');
                const paymentsError = await paymentsResponse.text().catch(() => '');
                console.error('API Errors - Fees:', feesError, 'Payments:', paymentsError);
                throw new Error(`HTTP error! status: ${feesResponse.status}/${paymentsResponse.status}`);
            }
            
            const [feesData, paymentsData] = await Promise.all([
                feesResponse.json(),
                paymentsResponse.json()
            ]);
            
            console.log('Fees API Response:', feesData);
            console.log('Payments API Response:', paymentsData);
            
            // Process fee records to get expected fees
            const fees = Array.isArray(feesData) ? feesData : (feesData.data || []);
            let totalExpectedFees = 0;
            let totalPaidFees = 0;
            
            console.log('=== FEE RECORDS ===');
            console.log(JSON.stringify(fees, null, 2));
            console.log('===================');
            
            // Calculate total expected fees from fee records
            fees.forEach(fee => {
                const feeAmount = parseFloat(fee.fees_per_term || fee.amount || fee.totalFees || 0);
                totalExpectedFees += feeAmount;
            });
            
            // Process payments data directly
            const payments = Array.isArray(paymentsData) ? paymentsData : (paymentsData?.data || []);
            console.log('Raw payments data:', JSON.stringify(payments, null, 2));
            
            // Sum up all completed/successful payments
            totalPaidFees = payments.reduce((sum, payment, index) => {
                console.log(`\n--- Processing Payment ${index + 1} ---`);
                console.log('Payment object:', payment);
                
                // Check if payment has the expected structure
                if (!payment) {
                    console.log('Skipping null/undefined payment');
                    return sum;
                }
                
                // Check status (case insensitive)
                const status = String(payment.status || '').toLowerCase();
                const isCompleted = status === 'completed' || status === 'success' || status === 'paid';
                
                console.log('Payment status:', status, 'Completed:', isCompleted);
                
                if (isCompleted) {
                    // Try different possible amount fields
                    const amount = parseFloat(
                        payment.amount || 
                        payment.payment_amount || 
                        payment.amount_paid ||
                        payment.paidAmount ||
                        0
                    );
                    
                    console.log('Payment amount found:', amount);
                    return sum + (isNaN(amount) ? 0 : amount);
                }
                
                return sum;
            }, 0);
            
            console.log('Total paid calculated:', totalPaidFees);
            
            console.log('\n=== FEE CALCULATION ===');
            console.log('Total Expected Fees:', totalExpectedFees);
            console.log('Total Paid Fees:', totalPaidFees);
            console.log('======================');
            
            console.log('Total Expected Fees:', totalExpectedFees);
            console.log('Total Paid Fees:', totalPaidFees);
            
            // Update the dashboard
            const feeCountElement = document.getElementById('fee-count');
            const feePaidElement = document.getElementById('fee-paid');
            const feeSummaryElement = document.getElementById('fee-summary');
            
            if (feeCountElement) {
                feeCountElement.textContent = `Ksh ${totalExpectedFees.toLocaleString()}`;
            }
            
            if (feePaidElement) {
                feePaidElement.textContent = `Paid: Ksh ${totalPaidFees.toLocaleString()}`;
                // Change color based on payment status (green if fully paid, red if not)
                feePaidElement.style.color = totalPaidFees >= totalExpectedFees ? '#4CAF50' : '#f44336';
            }
            
            if (feeSummaryElement) {
                const paymentPercentage = totalExpectedFees > 0 
                    ? Math.round((totalPaidFees / totalExpectedFees) * 100) 
                    : 0;
                feeSummaryElement.textContent = `${paymentPercentage}% of term fees collected`;
            }
            
        } catch (error) {
            console.error('Error loading fees data:', error);
            const feeCountElement = document.getElementById('fee-count');
            const feePaidElement = document.getElementById('fee-paid');
            
            if (feeCountElement) feeCountElement.textContent = 'Error loading';
            if (feePaidElement) feePaidElement.textContent = 'Payment data error';
        }
    }
    
    // Load total fees when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM fully loaded, calling loadTotalFees');
        loadTotalFees();
    });
    
    // Make the function available globally if needed
    window.loadTotalFees = async function() {
        console.log('loadTotalFees function started');
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                return;
            }
            
            console.log('Fetching fees from API...');
            const feesResponse = await fetch('http://localhost:5000/api/fees?populate=student', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!feesResponse.ok) {
                console.error('Error fetching fee data:', await feesResponse.text());
                throw new Error('Failed to fetch fee data');
            }
            
            const feesData = await feesResponse.json();
            console.log('=== FEE RECORDS ===', feesData);
            
            // Process fee records to get expected and paid fees
            const fees = Array.isArray(feesData) ? feesData : (feesData.data || []);
            let totalExpectedFees = 0;
            let totalPaidFees = 0;
            
            // Process each fee record
            fees.forEach(fee => {
                // Get the expected fee amount
                const feeAmount = parseFloat(fee.fees_per_term || fee.amount || fee.totalFees || 0);
                totalExpectedFees += feeAmount;
                
                // Check if there are payments in this fee record
                if (fee.payments && Array.isArray(fee.payments)) {
                    // Sum up all payments for this fee
                    const feePaid = fee.payments.reduce((sum, payment) => {
                        return sum + (parseFloat(payment.amount) || 0);
                    }, 0);
                    
                    console.log(`Fee ${fee._id}:`, {
                        expected: feeAmount,
                        paid: feePaid,
                        payments: fee.payments
                    });
                    
                    totalPaidFees += feePaid;
                } else if (fee.paidAmount !== undefined) {
                    // Fallback to paidAmount if payments array is not available
                    const paid = parseFloat(fee.paidAmount) || 0;
                    console.log(`Fee ${fee._id} using paidAmount:`, paid);
                    totalPaidFees += paid;
                }
            });
            
            console.log('=== TOTALS ===');
            console.log('Total Expected Fees:', totalExpectedFees);
            console.log('Total Paid Fees:', totalPaidFees);
            
            // Calculate balance
            const balance = Math.max(0, totalExpectedFees - totalPaidFees);
            
            // Update the UI
            const feeCountElement = document.getElementById('fee-count');
            const feePaidElement = document.getElementById('fee-paid');
            const feeBalanceElement = document.getElementById('fee-balance');
            
            if (feeCountElement) {
                feeCountElement.textContent = `Ksh ${totalExpectedFees.toLocaleString()}`;
            }
            
            if (feePaidElement) {
                feePaidElement.textContent = `Paid: Ksh ${totalPaidFees.toLocaleString()}`;
                feePaidElement.style.color = totalPaidFees >= totalExpectedFees ? '#4CAF50' : '#2196F3';
            }
            
            if (feeBalanceElement) {
                feeBalanceElement.textContent = `Balance: Ksh ${balance.toLocaleString()}`;
                feeBalanceElement.style.color = balance > 0 ? '#f44336' : '#4CAF50';
            }
            
        } catch (error) {
            console.error('Error in loadTotalFees:', error);
            const feeCountElement = document.getElementById('fee-count');
            const feePaidElement = document.getElementById('fee-paid');
            
            if (feeCountElement) feeCountElement.textContent = 'Error loading';
            if (feePaidElement) feePaidElement.textContent = 'Payment data error';
        }
    };
    
    // Function to load and update clubs count on dashboard
    async function loadClubsCount() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                return;
            }
            
            console.log('Fetching clubs from API...');
            const response = await fetch('http://localhost:5000/api/clubs', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Clubs API Error:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Clubs API Response:', data);
            
            // Handle both array and object responses
            const clubs = Array.isArray(data) ? data : (data.data || []);
            console.log('Total clubs found:', clubs.length);
            
            // Update the dashboard
            const clubCountElement = document.getElementById('club-count');
            if (clubCountElement) {
                clubCountElement.textContent = clubs.length;
                
                // Update the chart if it exists
                if (window.clubsChart) {
                    window.clubsChart.data.datasets[0].data = [clubs.length];
                    window.clubsChart.update();
                }
            } else {
                console.error('club-count element not found in the DOM');
            }
            
            return clubs.length;
            
        } catch (error) {
            console.error('Error loading clubs count:', error);
            const clubCountElement = document.getElementById('club-count');
            if (clubCountElement) {
                clubCountElement.textContent = 'Error';
            }
            return 0;
        }
    }
    
    // Load counts when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadBooksCount();
        loadClubsCount();
        
        // Initialize clubs chart
        const chartClubs = document.getElementById('chart-clubs');
        if (chartClubs) {
            const ctxClubs = chartClubs.getContext('2d');
            window.clubsChart = new Chart(ctxClubs, {
                type: 'doughnut',
                data: {
                    labels: ['Clubs'],
                    datasets: [{
                        data: [0],
                        backgroundColor: ['#10B981']
                    }]
                },
                options: { 
                    plugins: { 
                        legend: { display: false } 
                    }, 
                    cutout: '70%' 
                }
            });
        }
    });
    
    // Make the function available globally if needed
    window.loadClubsCount = loadClubsCount;
    
    // Function to load and update books count on dashboard
    async function loadBooksCount() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                return;
            }
            
            console.log('Fetching books from API...');
            const response = await fetch('http://localhost:5000/api/library', {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('Books API Error:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Books API Response:', data);
            
            // Handle both array and object responses
            const books = Array.isArray(data) ? data : (data.data || []);
            console.log('Total books found:', books.length);
            
            // Calculate total copies (sum of all copies)
            let totalCopies = 0;
            if (books.length > 0) {
                totalCopies = books.reduce((sum, book) => {
                    return sum + (parseInt(book.copies || 1, 10) || 0);
                }, 0);
            }
            
            // Update the dashboard
            const bookCountElement = document.getElementById('book-count');
            if (bookCountElement) {
                bookCountElement.textContent = totalCopies;
                
                // Update the chart if it exists
                if (window.booksChart) {
                    window.booksChart.data.datasets[0].data = [totalCopies];
                    window.booksChart.update();
                }
            } else {
                console.error('book-count element not found in the DOM');
            }
            
            return totalCopies;
            
        } catch (error) {
            console.error('Error loading books count:', error);
            const bookCountElement = document.getElementById('book-count');
            if (bookCountElement) {
                bookCountElement.textContent = 'Error';
            }
            return 0;
        }
    }
    
    // Load books count when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        loadBooksCount();
        
        // Initialize books chart if it doesn't exist
        const chartBooks = document.getElementById('chart-books');
        if (chartBooks && !window.booksChart) {
            const ctxBooks = chartBooks.getContext('2d');
            window.booksChart = new Chart(ctxBooks, {
                type: 'doughnut',
                data: {
                    labels: ['Books'],
                    datasets: [{
                        data: [0],
                        backgroundColor: ['#3B82F6']
                    }]
                },
                options: { 
                    plugins: { 
                        legend: { display: false } 
                    }, 
                    cutout: '70%' 
                }
            });
        }
    });
    
    // Make the function available globally if needed
    window.loadBooksCount = loadBooksCount;
    
    // Initialize dashboard when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle password visibility
        document.querySelectorAll('.toggle-password').forEach(button => {
            button.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const icon = this.querySelector('i');
                
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });
        
        // Toggle change password form
        const togglePasswordBtn = document.getElementById('toggle-password-btn');
        if (togglePasswordBtn) {
            togglePasswordBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const form = document.querySelector('.change-password-section');
                form.style.display = form.style.display === 'none' ? 'block' : 'none';
            });
        }
        
        // Initialize mini charts
        initializeMiniCharts();
        
        // Load all dashboard data
        loadDashboardData();
    });
    
    // Initialize mini charts for dashboard cards
    function initializeMiniCharts() {
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false }
            },
            scales: {
                x: { display: false },
                y: { display: false }
            },
            elements: {
                line: {
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                },
                point: { radius: 0 }
            }
        };
        
        // Students chart
        const studentsCtx = document.getElementById('chart-students')?.getContext('2d');
        if (studentsCtx) {
            new Chart(studentsCtx, {
                type: 'line',
                data: {
                    labels: Array(12).fill(''),
                    datasets: [{
                        data: [30, 40, 45, 50, 45, 55, 60, 65, 70, 75, 80, 85],
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2
                    }]
                },
                options: chartOptions
            });
        }
        
        // Teachers chart
        const teachersCtx = document.getElementById('chart-teachers')?.getContext('2d');
        if (teachersCtx) {
            new Chart(teachersCtx, {
                type: 'line',
                data: {
                    labels: Array(12).fill(''),
                    datasets: [{
                        data: [5, 7, 8, 8, 9, 10, 10, 11, 12, 12, 12, 12],
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2
                    }]
                },
                options: chartOptions
            });
        }
    }
    
    // Load profile data
    async function loadProfileData() {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch('http://localhost:5000/api/auth/me', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const user = await response.json();
                document.getElementById('profile-name').textContent = user.name || 'User';
                document.getElementById('admin-name').textContent = user.name || 'Admin';
            }
        } catch (error) {
            console.error('Error loading profile:', error);
        }
    }
    
    // Load total fees
    async function loadTotalFees() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch('http://localhost:5000/api/fees', {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await response.json();
            
            let total = 0;
            const fees = Array.isArray(data) ? data : (data.data || []);
            fees.forEach(fee => {
                total += Number(fee.fees_per_term || fee.amount || 0);
            });
            
            document.getElementById('fee-count').textContent = `Ksh ${total.toLocaleString()}`;
            return true;
        } catch (error) {
            console.error('Error loading fees:', error);
            document.getElementById('fee-count').textContent = 'Error';
            return false;
        }
    }
    
    // Load students count
    async function loadStudentsCount() {
        try {
            const token = localStorage.getItem('token');
            // Try to fetch students from the correct endpoint
            const response = await fetch('http://localhost:5000/api/students', {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            const students = Array.isArray(data) ? data : [];
            document.getElementById('student-count').textContent = students.length;
            return true;
            
        } catch (error) {
            console.error('Error loading students:', error);
            document.getElementById('student-count').textContent = '-';
            return false;
        }
    }
    
    // Load teachers count
    async function loadTeachersCount() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No token found in localStorage');
                throw new Error('Authentication required');
            }
            
            // First, try to get the count from the server
            const response = await fetch('http://localhost:5000/api/teachers/count', {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data && typeof data.count !== 'undefined') {
                    document.getElementById('teacher-count').textContent = data.count;
                    return true;
                }
            }
            
            // If count endpoint fails, try to fetch all teachers and count them
            const teachersResponse = await fetch('http://localhost:5000/api/teachers', {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (teachersResponse.ok) {
                const data = await teachersResponse.json();
                let teachers = [];
                
                // Handle different response formats
                if (Array.isArray(data)) {
                    teachers = data;
                } else if (data && Array.isArray(data.teachers)) {
                    teachers = data.teachers;
                } else if (data && Array.isArray(data.data)) {
                    teachers = data.data;
                }
                
                // Filter out non-teacher staff if needed
                const actualTeachers = teachers.filter(teacher => 
                    teacher.role === 'teacher' || 
                    teacher.type === 'teacher' ||
                    teacher.userType === 'teacher'
                );
                
                const count = actualTeachers.length > 0 ? actualTeachers.length : teachers.length;
                document.getElementById('teacher-count').textContent = count;
                return true;
            }
            
            throw new Error('Failed to fetch teacher count');
            
            
            for (const endpoint of endpoints) {
                try {
                    const url = `http://localhost:5000${endpoint}`;
                    console.log(`Trying endpoint: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: { 
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('Teachers API response:', data);
                        
                        // Handle different response formats
                        let teachers = [];
                        if (Array.isArray(data)) {
                            teachers = data;
                        } else if (data && Array.isArray(data.teachers)) {
                            teachers = data.teachers;
                        } else if (data && Array.isArray(data.data)) {
                            teachers = data.data;
                        }
                        
                        document.getElementById('teacher-count').textContent = teachers.length;
                        return true;
                    } else {
                        console.warn(`Endpoint ${endpoint} returned status: ${response.status}`);
                        lastError = new Error(`HTTP error! status: ${response.status}`);
                    }
                } catch (err) {
                    console.warn(`Error with endpoint ${endpoint}:`, err);
                    lastError = err;
                }
            }
            
            // If we get here, all endpoints failed
            throw lastError || new Error('All teacher endpoints failed');
            
        } catch (error) {
            console.error('Error loading teachers:', error);
            document.getElementById('teacher-count').textContent = '-';
            return false;
        }
    }
    
    // Load books count and issued books
    async function loadBooksCount() {
        console.log('=== loadBooksCount function STARTED ===');
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No authentication token found');
                return;
            }
            
            console.log('Fetching books from API...');
            const response = await fetch('http://localhost:5000/api/books', {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('API Error:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Books API response:', data);
            
            // Handle different response formats
            let books = [];
            if (Array.isArray(data)) {
                books = data;
            } else if (data && Array.isArray(data.data)) {
                books = data.data;
            } else if (data.books) {
                books = data.books;
            } else if (typeof data === 'object' && data !== null) {
                // If it's an object but not an array, try to extract books from it
                books = Object.values(data).filter(item => item && typeof item === 'object');
            }
            
            // Log detailed information about the first few books
            if (books.length > 0) {
                console.log('=== DEBUG: First 3 books structure ===');
                books.slice(0, 3).forEach((book, index) => {
                    console.log(`\nBook ${index + 1} fields:`, Object.keys(book));
                    console.log(`Book ${index + 1} data:`, {
                        id: book._id || book.id,
                        title: book.title || 'No title',
                        status: book.status,
                        borrowerId: book.borrowerId,
                        borrower: book.borrower,
                        borrowerName: book.borrowerName,
                        issuedTo: book.issuedTo,
                        copies: book.copies,
                        // Include any other relevant fields
                        ...Object.entries(book).reduce((acc, [key, value]) => {
                            if (['_id', 'id', 'title', 'status', 'borrowerId', 'borrower', 'borrowerName', 'issuedTo', 'copies'].includes(key)) {
                                return acc;
                            }
                            return { ...acc, [key]: value };
                        }, {})
                    });
                });
                console.log('=== END DEBUG ===');
            }
            
            console.log('Processing books. Total books found:', books.length);
            
            // Log the first few books to see their structure
            if (books.length > 0) {
                console.log('Sample book structure:', JSON.stringify(books[0], null, 2));
                
                // Log all available fields in the first book
                const sampleBook = books[0];
                console.log('Available fields in book object:', Object.keys(sampleBook));
                
                // Log any fields that might indicate a book is issued
                const possibleIssuedFields = ['status', 'borrowerId', 'borrower', 'borrowerName', 'issuedTo', 'checkedOut'];
                const presentFields = possibleIssuedFields.filter(field => field in sampleBook);
                console.log('Fields that might indicate issued status:', presentFields);
            }
            
            // Calculate total books (sum of all copies)
            const totalBooks = books.reduce((total, book) => {
                return total + (parseInt(book.copies) || 1);
            }, 0);
            
            // Calculate issued books - check multiple possible fields
            const issuedBooks = books.filter(book => {
                // Check for any of these fields that would indicate the book is issued
                const isIssued = (
                    (book.borrowerId && book.borrowerId.length > 0) ||
                    (book.borrower && (typeof book.borrower === 'string' ? book.borrower.length > 0 : true)) ||
                    (book.issuedTo && book.issuedTo.length > 0) ||
                    (book.status && ['issued', 'borrowed', 'checked out', 'out'].includes(String(book.status).toLowerCase()))
                );
                
                // Log details for the first few issued books
                if (isIssued) {
                    console.log('Found issued book:', {
                        id: book._id || book.id,
                        title: book.title,
                        status: book.status,
                        borrowerId: book.borrowerId,
                        borrower: book.borrower,
                        issuedTo: book.issuedTo
                    });
                }
                
                return isIssued;
            });
            
            console.log(`Total books: ${totalBooks}, Issued books: ${issuedBooks.length}`);
            
            // Update the UI
            const bookCountElement = document.getElementById('book-count');
            const issuedBooksElement = document.getElementById('issued-books-count');
            
            if (bookCountElement) {
                bookCountElement.textContent = totalBooks;
            }
            
            if (issuedBooksElement) {
                issuedBooksElement.textContent = `Issued: ${issuedBooks.length}`;
                // Color code based on issued books percentage
                const issuedPercentage = totalBooks > 0 ? (issuedBooks.length / totalBooks) : 0;
                issuedBooksElement.style.color = issuedPercentage > 0.7 ? '#f44336' : '#4CAF50';
            }
            
            return true;
        } catch (error) {
            console.error('Error loading books:', error);
            const bookCountElement = document.getElementById('book-count');
            const issuedBooksElement = document.getElementById('issued-books-count');
            
            if (bookCountElement) {
                bookCountElement.textContent = '-';
            }
            
            if (issuedBooksElement) {
                issuedBooksElement.textContent = 'Issued: -';
            }
            
            return false;
        } finally {
            console.log('=== loadBooksCount function COMPLETED ===');
        }
    }
    
    // Load today's attendance
    async function loadTodayAttendance() {
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                console.error('No token found in localStorage');
                throw new Error('Authentication required');
            }
            
            // Get today's date in YYYY-MM-DD format
            const today = new Date();
            const todayFormatted = today.toISOString().split('T')[0];
            
            // First update the date display immediately
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('attendance-date').textContent = `Today • ${today.toLocaleDateString('en-US', options)}`;
            
            // Try to get today's attendance
            const response = await fetch(`http://localhost:5000/api/attendance?date=${todayFormatted}`, {
                method: 'GET',
                headers: { 
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            console.log('Attendance API response:', data);
            
            let present = 0;
            let absent = 0;
            
            // Handle different response formats
            if (Array.isArray(data)) {
                // If we get an array, find today's record
                const todayRecord = data.find(record => {
                    const recordDate = record.date ? new Date(record.date).toISOString().split('T')[0] : null;
                    return recordDate === todayFormatted;
                });
                
                if (todayRecord) {
                    present = parseInt(todayRecord.present || 0);
                    absent = parseInt(todayRecord.absent || 0);
                    
                    // If we have records array, count actual present/absent
                    if (Array.isArray(todayRecord.records)) {
                        present = todayRecord.records.filter(r => r.status === 'present' || r.status === 'late').length;
                        absent = todayRecord.records.filter(r => r.status === 'absent').length;
                    }
                }
            } else if (typeof data === 'object' && data !== null) {
                // If we get an object with direct counts
                present = parseInt(data.present || 0);
                absent = parseInt(data.absent || 0);
                
                // If we have records array, count actual present/absent
                if (Array.isArray(data.records)) {
                    present = data.records.filter(r => r.status === 'present' || r.status === 'late').length;
                    absent = data.records.filter(r => r.status === 'absent').length;
                }
            }
            
            // Update the UI with the counts
            document.getElementById('today-present').textContent = present;
            document.getElementById('today-absent').textContent = absent;
            
            // Update progress bars
            const total = present + absent || 1; // Avoid division by zero
            const presentPercentage = Math.round((present / total) * 100);
            const absentPercentage = Math.round((absent / total) * 100);
            
            document.getElementById('present-percentage').style.width = `${presentPercentage}%`;
            document.getElementById('absent-percentage').style.width = `${absentPercentage}%`;
            
            console.log(`Attendance updated: ${present} present, ${absent} absent`);
            return true;
            
        } catch (error) {
            console.error('Error loading attendance:', error);
            document.getElementById('today-present').textContent = '0';
            document.getElementById('today-absent').textContent = '0';
            document.getElementById('present-percentage').style.width = '0%';
            document.getElementById('absent-percentage').style.width = '0%';
            document.getElementById('attendance-date').textContent = 'Error loading data';
            return false;
        }
    }
    
    // Initialize the dashboard when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        // Load all dashboard data
        loadDashboardData();
        
        // Set up auto-refresh every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    });
    
    // Load all dashboard data
    async function loadDashboardData() {
        try {
            await Promise.all([
                loadStudentsCount(),
                loadTeachersCount(),
                loadBooksCount(),
                loadClubsCount(),
                loadTotalFees(),
                loadTodayAttendance()
            ]);
            console.log('Dashboard data loaded successfully');
        } catch (error) {
            console.error('Error loading dashboard data:', error);
        }
    }
    

    
    // Load fees data
    async function loadFeesData() {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const response = await fetch('http://localhost:5000/api/fees/summary', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                const totalFees = data.totalFees || 0;
                const formattedFees = new Intl.NumberFormat('en-KE', {
                    style: 'currency',
                    currency: 'KES',
                    minimumFractionDigits: 0
                }).format(totalFees);
                
                document.getElementById('fee-count').textContent = formattedFees;
                
                // Update fee summary if available
                if (data.percentageChange) {
                    const trend = data.percentageChange >= 0 ? 'up' : 'down';
                    const feeSummary = document.getElementById('fee-summary');
                    if (feeSummary) {
                        feeSummary.innerHTML = `
                            <i class="fas fa-arrow-${trend}"></i> 
                            ${Math.abs(data.percentageChange)}% from last term
                        `;
                        feeSummary.className = `stat-trend text-${trend === 'up' ? 'success' : 'danger'}`;
                    }
                }
            }
        } catch (error) {
            console.error('Error loading fees data:', error);
        }
    }
    
    // Load attendance data
    async function loadAttendanceData() {
        try {
            const token = localStorage.getItem('token');
            if (!token) return;
            
            const today = new Date().toISOString().split('T')[0];
            const response = await fetch(`http://localhost:5000/api/attendance/summary?date=${today}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (response.ok) {
                const data = await response.json();
                const present = data.present || 0;
                const absent = data.absent || 0;
                const total = present + absent;
                
                document.getElementById('today-present').textContent = present;
                document.getElementById('today-absent').textContent = absent;
                
                // Update progress bars
                if (total > 0) {
                    const presentPercent = Math.round((present / total) * 100);
                    const absentPercent = 100 - presentPercent;
                    
                    document.getElementById('present-percentage').style.width = `${presentPercent}%`;
                    document.getElementById('absent-percentage').style.width = `${absentPercent}%`;
                }
                
                // Update date
                const dateElement = document.getElementById('attendance-date');
                if (dateElement) {
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dateElement.textContent = new Date().toLocaleDateString('en-US', options);
                }
            }
        } catch (error) {
            console.error('Error loading attendance data:', error);
        }
    }
    
    // Make functions available globally
    window.loadDashboardData = loadDashboardData;
    
    // Ensure loadBooksCount is called when the page loads
    document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded, calling loadBooksCount');
        loadBooksCount().catch(console.error);
    });
    </script>
    
    <!-- Attendance Auto-Load Script -->
    <script>
        // Make loadTodaysAttendance globally available
        if (typeof loadTodaysAttendance === 'function') {
            window.loadTodaysAttendance = loadTodaysAttendance;
            
            // Load attendance data when the page loads
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Loading attendance data...');
                    loadTodaysAttendance().catch(console.error);
                });
            } else {
                console.log('Loading attendance data now...');
                loadTodaysAttendance().catch(console.error);
            }
        } else {
            console.error('Failed to initialize attendance loading');
        }
    </script>

    <!-- Class Management JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            const classSelect = document.getElementById('class-select');
            const studentList = document.getElementById('student-list');
            const studentProfile = document.getElementById('student-profile');
            
            // Store current class students
            let currentClassStudents = [];
            
            // Format date helper function
            const formatDate = (dateString) => {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return isNaN(date.getTime()) ? 'N/A' : date.toLocaleDateString();
                } catch (e) {
                    console.error('Error formatting date:', e);
                    return 'N/A';
                }
            };
            
            // Event listener for class selection
            if (classSelect) {
                classSelect.addEventListener('change', async function() {
                    const className = this.value;
                    if (!className) {
                        studentList.innerHTML = '<div class="empty-state">Select a class to view students</div>';
                        studentProfile.innerHTML = `
                            <div class="empty-profile">
                                <i class="fas fa-user-graduate"></i>
                                <p>Select a class to view students</p>
                            </div>`;
                        return;
                    }
                    
                    try {
                        // Show loading state
                        studentList.innerHTML = '<div class="loading">Loading students...</div>';
                        
                        // Clear previous student profile
                        studentProfile.innerHTML = `
                            <div class="empty-profile">
                                <i class="fas fa-spinner fa-spin"></i>
                                <p>Loading students...</p>
                            </div>`;
                        
                        // Fetch students for the selected class
                        const students = await loadStudentsForClass(className);
                        currentClassStudents = students;
                        
                        // Display students
                        displayStudents(students);
                        
                        // Clear student profile
                        studentProfile.innerHTML = `
                            <div class="empty-profile">
                                <i class="fas fa-user-graduate"></i>
                                <p>Select a student to view profile</p>
                            </div>`;
                            
                    } catch (error) {
                        console.error('Error loading students:', error);
                        studentList.innerHTML = `
                            <div class="error">
                                <p>Error loading students. Please try again.</p>
                                <p class="small">${error.message || ''}</p>
                            </div>`;
                    }
                });
            }
            
            // Function to load students for a class
            async function loadStudentsForClass(className) {
                try {
                    console.log(`Loading students for class: ${className}`);
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('No authentication token found');
                    }
                    
                    const response = await fetch(`http://localhost:5000/api/students/class/${encodeURIComponent(className)}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('API Error Response:', errorText);
                        throw new Error(`Failed to load students: ${response.status} ${response.statusText}`);
                    }
                    
                    const result = await response.json();
                    console.log('API Response:', result);
                    
                    // Handle different response formats
                    if (Array.isArray(result)) {
                        return result;
                    } else if (result && Array.isArray(result.data)) {
                        return result.data;
                    } else if (result && result.students) {
                        return result.students;
                    } else if (result && result.success && Array.isArray(result.data)) {
                        return result.data;
                    }
                    
                    throw new Error('Unexpected response format from server');
                    
                } catch (error) {
                    console.error('Error in loadStudentsForClass:', error);
                    throw error;
                }
            }
            
            // Function to display students in the list
            function displayStudents(students) {
                console.log('Displaying students:', students);
                
                if (!students || !students.length) {
                    studentList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-user-graduate"></i>
                            <p>No students found in this class</p>
                        </div>`;
                    return;
                }
                
                try {
                    // Clear the student list
                    studentList.innerHTML = '';
                    
                    // Create a document fragment for better performance
                    const fragment = document.createDocumentFragment();
                    
                    students.forEach(student => {
                        if (!student || typeof student !== 'object') {
                            console.warn('Invalid student data:', student);
                            return;
                        }
                        
                        // Get student data with fallbacks
                        const studentId = student._id || student.id || '';
                        const fullName = student.name || student.fullName || 'Unknown Student';
                        const [firstName, ...lastNameParts] = fullName.split(' ');
                        const lastName = lastNameParts.join(' ');
                        const initials = (firstName[0] + (lastName ? lastName[0] : '')).toUpperCase();
                        const admissionNumber = student.admissionNumber || student.admissionNo || 'N/A';
                        
                        // Create student item
                        const studentItem = document.createElement('div');
                        studentItem.className = 'student-item';
                        studentItem.dataset.studentId = studentId;
                        
                        studentItem.innerHTML = `
                            <div class="student-avatar">${initials}</div>
                            <div class="student-info">
                                <h4>${fullName}</h4>
                                <p>Admission: ${admissionNumber}</p>
                            </div>
                        `;
                        
                        // Add click handler
                        studentItem.addEventListener('click', () => {
                            displayStudentProfile(student);
                        });
                        
                        fragment.appendChild(studentItem);
                    });
                    
                    // Append all student items at once for better performance
                    studentList.appendChild(fragment);
                    
                } catch (error) {
                    console.error('Error rendering students:', error);
                    studentList.innerHTML = `
                        <div class="error">
                            <p>Error displaying student list. Please try again.</p>
                            <p class="small">${error.message || ''}</p>
                        </div>`;
                }
            }
            
            // Function to find student in the current class data
            function findStudentInCurrentClass(studentId) {
                return currentClassStudents.find(s => (s._id === studentId || s.id === studentId));
            }
            
            // Function to format student profile HTML to match teacher dashboard
            function formatStudentProfile(student) {
                if (!student) return '<div class="error">Student not found</div>';
                
                // Get student initials for avatar
                const fullName = student.name || student.fullName || 'Unknown Student';
                const [firstName, ...lastNameParts] = fullName.split(' ');
                const lastName = lastNameParts.join(' ');
                const initials = (firstName[0] + (lastName ? lastName[0] : '')).toUpperCase();
                
                // Format date of birth if it exists
                let dob = 'N/A';
                if (student.dateOfBirth) {
                    const dobDate = new Date(student.dateOfBirth);
                    if (!isNaN(dobDate.getTime())) {
                        dob = dobDate.toLocaleDateString('en-US', {month: 'numeric', day: 'numeric', year: 'numeric'});
                    }
                }
                
                // Get class and level information
                const className = student.class || student.className || 'N/A';
                const level = className.includes('Grade') ? 'Primary School' : 
                             className.includes('Form') ? 'Secondary School' : 'N/A';
                
                return `
                    <div class="profile-header">
                        <div class="profile-avatar">${initials}</div>
                        <div class="profile-info">
                            <h2>${fullName}</h2>
                            <p>Student ID: ${student.admissionNumber || student.admissionNo || 'N/A'}</p>
                            <p>Gender: ${student.gender || 'N/A'}</p>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Personal Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Date of Birth:</span>
                            <span class="detail-value">${dob}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Gender:</span>
                            <span class="detail-value">${student.gender || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Parent/Guardian:</span>
                            <span class="detail-value">${student.parentName || student.parent || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Parent Contact:</span>
                            <span class="detail-value">${student.parentContact || student.contactNumber || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Contact Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Email:</span>
                            <span class="detail-value">${student.email || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Phone:</span>
                            <span class="detail-value">${student.phone || student.contactNumber || 'N/A'}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Address:</span>
                            <span class="detail-value">${student.address || 'N/A'}</span>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Class Information</h3>
                        <div class="detail-row">
                            <span class="detail-label">Class:</span>
                            <span class="detail-value">${className}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Level:</span>
                            <span class="detail-value">${level}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label">Status:</span>
                            <span class="detail-value ${student.status === 'Active' ? 'status-active' : 'status-inactive'}">
                                ${student.status || 'Active'}
                            </span>
                        </div>
                    </div>
                `;
            }
            
            // Function to display student profile
            function displayStudentProfile(student) {
                if (!student) {
                    studentProfile.innerHTML = `
                        <div class="empty-profile">
                            <i class="fas fa-exclamation-circle"></i>
                            <p>Error loading student profile</p>
                        </div>`;
                    return;
                }
                
                try {
                    // Extract student data with fallbacks
                    const fullName = student.name || student.fullName || 'Unknown Student';
                    const [firstName, ...lastNameParts] = fullName.split(' ');
                    const lastName = lastNameParts.join(' ');
                    const initials = (firstName[0] + (lastName ? lastName[0] : '')).toUpperCase();
                    
                    // Get class information
                    const classSelect = document.getElementById('class-select');
                    const selectedClass = classSelect ? classSelect.options[classSelect.selectedIndex] : null;
                    const className = selectedClass ? selectedClass.text : (student.className || student.class || 'N/A');
                    
                    // Get admission number
                    const admissionNumber = student.admissionNumber || student.admissionNo || 'N/A';
                    
                    // Format parent/guardian info
                    const parentName = student.parentName || student.parent || 'N/A';
                    const parentContact = student.parentContact || student.contactNumber || 'N/A';
                    
                    // Format date of birth
                    const dob = formatDate(student.dob || student.dateOfBirth);
                    
                    // Create profile HTML
                    studentProfile.innerHTML = `
                        <div class="profile-header">
                            <div class="profile-avatar">${initials}</div>
                            <div class="profile-info">
                                <h3>${fullName}</h3>
                                <p class="student-class">${className}</p>
                            </div>
                        </div>
                        
                        <div class="profile-details">
                            <div class="detail-row">
                                <span class="detail-label">Admission No:</span>
                                <span class="detail-value">${admissionNumber}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Date of Birth:</span>
                                <span class="detail-value">${dob}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Gender:</span>
                                <span class="detail-value">${student.gender || 'N/A'}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Parent/Guardian:</span>
                                <span class="detail-value">${parentName}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Contact:</span>
                                <span class="detail-value">${parentContact}</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Status:</span>
                                <span class="detail-value">${student.status || 'Active'}</span>
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    console.error('Error displaying student profile:', error);
                    studentProfile.innerHTML = `
                        <div class="error">
                            <p>Error displaying student profile. Please try again.</p>
                            <p class="small">${error.message || ''}</p>
                        </div>`;
                }
            }
            
            // Show success message
            function showSuccess(message) {
                const messageDiv = document.getElementById('class-message');
                if (messageDiv) {
                    messageDiv.textContent = message;
                    messageDiv.style.display = 'block';
                    messageDiv.className = 'alert alert-success';
                    
                    // Hide after 5 seconds
                    setTimeout(() => {
                        messageDiv.style.display = 'none';
                    }, 5000);
                }
            }
            
            // Show error message
            function showError(message) {
                const messageDiv = document.getElementById('class-message');
                if (messageDiv) {
                    messageDiv.textContent = message;
                    messageDiv.style.display = 'block';
                    messageDiv.className = 'alert alert-error';
                }
            }
        });
    </script>
</body>

</html>
